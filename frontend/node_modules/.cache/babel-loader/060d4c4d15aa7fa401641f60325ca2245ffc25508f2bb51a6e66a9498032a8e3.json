{"ast":null,"code":"import{useState,useEffect,useRef,useCallback}from\"react\";import{toast}from\"react-hot-toast\";import{copyToClipboard}from\"../utils/clipboard\";import{useOrchestration}from\"./useOrchestration\";import{useWebSocket}from\"./useWebSocket\";import{crewAPI,handleAPIError}from\"../services/api\";import{useAuth}from\"../contexts/AuthContext\";/**\n * ë©€í‹°-ì—ì´ì „íŠ¸ AI ì‘ë‹µì„ íŒŒì‹±í•˜ê³  UIì— ë§ëŠ” ë©”ì‹œì§€ ê°ì²´ë¡œ ë³€í™˜\n */const processMultiAgentResponse=result=>{if(!result){console.error(\"ë©€í‹°-ì—ì´ì „íŠ¸ ì‘ë‹µ ì˜¤ë¥˜: ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤\",result);return{id:\"error-\"+Date.now(),type:\"assistant\",content:\"ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.\",timestamp:new Date().toISOString(),isError:true};}// ë©€í‹°-ì—ì´ì „íŠ¸ ê²°ê³¼ êµ¬ì„±\nconst agentResults=result.agentResults||{};const finalTitles=result.finalTitles||{};const tokenUsage=result.tokenUsage||0;// ì—ì´ì „íŠ¸ë³„ ê²°ê³¼ë¥¼ í¬ë§·íŒ…\nconst agentSummary=Object.keys(agentResults).map(agentType=>{const agentResult=agentResults[agentType];const titles=finalTitles[agentType]||[];return{agentType,agentName:getAgentName(agentType),result:(agentResult===null||agentResult===void 0?void 0:agentResult.content)||\"ê²°ê³¼ ì—†ìŒ\",titles:titles,tokenCount:(agentResult===null||agentResult===void 0?void 0:agentResult.tokenCount)||0};});// ì „ì²´ ì œëª© ëª©ë¡ ìƒì„±\nconst allTitles=Object.values(finalTitles).flat();return{id:\"multi-agent-\"+Date.now(),type:\"assistant\",content:formatMultiAgentContent(agentSummary,allTitles),timestamp:new Date(),// ë©€í‹°-ì—ì´ì „íŠ¸ íŠ¹í™” ë°ì´í„°\nisMultiAgent:true,agentResults:agentSummary,allTitles:allTitles,tokenUsage:tokenUsage};};/**\n * ì—ì´ì „íŠ¸ íƒ€ì…ì„ í•œêµ­ì–´ ì´ë¦„ìœ¼ë¡œ ë³€í™˜\n */const getAgentName=agentType=>{const agentNames={journalism:\"ğŸ“° ì €ë„ë¦¬ì¦˜ ì¶©ì‹¤í˜•\",balanced:\"âš–ï¸ ê· í˜•ì¡íŒ í›„í‚¹í˜•\",click:\"ğŸ¯ í´ë¦­ìœ ë„í˜•\",seo:\"ğŸ” SEO/AEO ìµœì í™”í˜•\",social:\"ğŸ“± ì†Œì…œë¯¸ë””ì–´ ê³µìœ í˜•\"};return agentNames[agentType]||`ğŸ¤– ${agentType}`;};/**\n * ë©€í‹°-ì—ì´ì „íŠ¸ ê²°ê³¼ë¥¼ UI í‘œì‹œìš© í…ìŠ¤íŠ¸ë¡œ í¬ë§·íŒ…\n */const formatMultiAgentContent=(agentSummary,allTitles)=>{let content=\"ğŸš€ **ë©€í‹°-ì—ì´ì „íŠ¸ ë¶„ì„ ì™„ë£Œ**\\n\\n\";// ì „ì²´ ì œëª© ìš”ì•½\nif(allTitles.length>0){content+=\"ğŸ“‹ **ìƒì„±ëœ ì œëª© ëª©ë¡:**\\n\";allTitles.forEach((title,index)=>{content+=`${index+1}. ${title}\\n`;});content+=\"\\n\";}// ì—ì´ì „íŠ¸ë³„ ìƒì„¸ ê²°ê³¼\ncontent+=\"ğŸ” **ì—ì´ì „íŠ¸ë³„ ë¶„ì„ ê²°ê³¼:**\\n\\n\";agentSummary.forEach(agent=>{content+=`### ${agent.agentName}\\n`;if(agent.titles.length>0){content+=\"**ìƒì„± ì œëª©:**\\n\";agent.titles.forEach(title=>{content+=`â€¢ ${title}\\n`;});}content+=`**í† í° ì‚¬ìš©ëŸ‰:** ${agent.tokenCount}ê°œ\\n\\n`;});return content;};/**\n * ì±„íŒ… ê¸°ëŠ¥ì„ ìœ„í•œ ì»¤ìŠ¤í…€ í›…\n * @param {string} projectId - í”„ë¡œì íŠ¸ ID\n * @param {string} projectName - í”„ë¡œì íŠ¸ ì´ë¦„\n * @param {Array} promptCards - í”„ë¡¬í”„íŠ¸ ì¹´ë“œ ë°°ì—´\n * @returns {Object} - ì±„íŒ… ê´€ë ¨ ìƒíƒœì™€ í•¨ìˆ˜ë“¤\n */export const useChat=function(projectId,projectName){let promptCards=arguments.length>2&&arguments[2]!==undefined?arguments[2]:[];let conversationId=arguments.length>3&&arguments[3]!==undefined?arguments[3]:null;const{user}=useAuth();// Add user from AuthContext\n// ë””ë²„ê¹… ë¡œê·¸ (ì²« ë²ˆì§¸ ë Œë”ë§ì—ë§Œ)\nconst isFirstRender=useRef(true);if(isFirstRender.current){console.log(\"ğŸ” [DEBUG] useChat ì´ˆê¸°í™”:\",{projectId,projectName,promptCardsLength:promptCards===null||promptCards===void 0?void 0:promptCards.length,conversationId,conversationIdType:typeof conversationId,isConversationIdNull:conversationId===null,isConversationIdUndefined:conversationId===undefined,userId:user===null||user===void 0?void 0:user.id});isFirstRender.current=false;}// conversationId ë³€ê²½ ê°ì§€\nuseEffect(()=>{console.log(\"ğŸ” [DEBUG] useChat - conversationId ë³€ê²½:\",{newConversationId:conversationId,conversationIdType:typeof conversationId,isNull:conversationId===null,isUndefined:conversationId===undefined});},[conversationId]);const[messages,setMessages]=useState([]);const[inputValue,setInputValue]=useState(\"\");const[copiedMessage,setCopiedMessage]=useState(null);const[canSendMessage,setCanSendMessage]=useState(true);const[inputHeight,setInputHeight]=useState(24);// ë™ì  ë†’ì´ ê´€ë¦¬\nconst[selectedModel,setSelectedModel]=useState(\"anthropic.claude-3-5-sonnet-20241022-v2:0\");const streamingMessageIdRef=useRef(null);const currentWebSocketRef=useRef(null);const currentExecutionIdRef=useRef(null);const messagesEndRef=useRef(null);const inputRef=useRef(null);// ì‚¬ìš©ì ìŠ¤í¬ë¡¤ ìƒíƒœ ì¶”ì \nconst[isUserScrolling,setIsUserScrolling]=useState(false);const scrollContainerRef=useRef(null);const lastScrollTopRef=useRef(0);const{isExecuting:isGenerating,isStreaming,executeOrchestration,resetOrchestration}=useOrchestration(projectId);// WebSocket í›… ì¶”ê°€\nconst{isConnected:wsConnected,isConnecting:wsConnecting,error:wsError,startStreaming:wsStartStreaming,addMessageListener,removeMessageListener}=useWebSocket(projectId);// ì´ˆê¸° ë©”ì‹œì§€ ì„¤ì • - projectId ë³€ê²½ì‹œì—ë§Œ ì´ˆê¸°í™”\nuseEffect(()=>{setMessages([]);// ë¹ˆ ë°°ì—´ë¡œ ì‹œì‘\n},[projectId]);// projectName ëŒ€ì‹  projectId ì‚¬ìš©\n// ì‚¬ìš©ì ìŠ¤í¬ë¡¤ ê°ì§€ í•¨ìˆ˜\nconst handleScroll=useCallback(()=>{if(!scrollContainerRef.current)return;const container=scrollContainerRef.current;const currentScrollTop=container.scrollTop;const maxScrollTop=container.scrollHeight-container.clientHeight;// ì‚¬ìš©ìê°€ ìˆ˜ë™ìœ¼ë¡œ ìŠ¤í¬ë¡¤í–ˆëŠ”ì§€ ê°ì§€\nif(Math.abs(currentScrollTop-lastScrollTopRef.current)>2){const isAtBottom=currentScrollTop>=maxScrollTop-20;// í•˜ë‹¨ì— ìˆì„ ë•Œë§Œ ìë™ ìŠ¤í¬ë¡¤ í—ˆìš©, ê·¸ ì™¸ëŠ” ì‚¬ìš©ì ìŠ¤í¬ë¡¤ ëª¨ë“œ\nsetIsUserScrolling(!isAtBottom);}lastScrollTopRef.current=currentScrollTop;},[]);const scrollToBottom=useCallback(()=>{// ì‚¬ìš©ìê°€ ìŠ¤í¬ë¡¤ ì¤‘ì´ ì•„ë‹ ë•Œë§Œ ìë™ ìŠ¤í¬ë¡¤\nif(!isUserScrolling&&messagesEndRef.current){messagesEndRef.current.scrollIntoView({behavior:\"smooth\"});}},[isUserScrolling]);// ë©”ì‹œì§€ ì¶”ê°€ ì‹œ ìŠ¤í¬ë¡¤ í•˜ë‹¨ìœ¼ë¡œ (ì‚¬ìš©ì ìŠ¤í¬ë¡¤ ì¤‘ì´ ì•„ë‹ ë•Œë§Œ)\nuseEffect(()=>{scrollToBottom();},[messages,scrollToBottom]);// WebSocket ë©”ì‹œì§€ ë¦¬ìŠ¤ë„ˆ ì„¤ì •\nuseEffect(()=>{const handleWebSocketMessage=event=>{var _data$message7;try{const data=JSON.parse(event.data);console.log(\"WebSocket ë©”ì‹œì§€ ìˆ˜ì‹ :\",data);const currentStreamingId=streamingMessageIdRef.current;switch(data.type){case\"stream_start\":console.log(\"WebSocket ìŠ¤íŠ¸ë¦¬ë° ì‹œì‘\");break;case\"progress\":// ì§„í–‰ ìƒí™© ë¡œê·¸ë§Œ ë‚¨ê¸°ê³  UI ì—…ë°ì´íŠ¸ëŠ” ì œê±°\nconsole.log(`ì§„í–‰ ìƒí™©: ${data.step} (${data.progress}%)`);break;case\"stream_chunk\":if(currentStreamingId){setMessages(prev=>{const updatedMessages=[...prev];const streamingMsgIndex=updatedMessages.findIndex(msg=>msg.id===currentStreamingId);console.log(\"ìŠ¤íŠ¸ë¦¼ ì²­í¬ ì²˜ë¦¬:\",{currentStreamingId,streamingMsgIndex,messagesLength:prev.length,content:data.content});if(streamingMsgIndex!==-1){// ê¸°ì¡´ ë‚´ìš©ì— ìƒˆ ì²­í¬ ì¶”ê°€\nconst currentContent=updatedMessages[streamingMsgIndex].content||\"\";updatedMessages[streamingMsgIndex]={...updatedMessages[streamingMsgIndex],content:currentContent+data.content,isLoading:true,isStreaming:true};console.log(\"ë©”ì‹œì§€ ì—…ë°ì´íŠ¸ë¨:\",updatedMessages[streamingMsgIndex]);}else{console.log(\"ìŠ¤íŠ¸ë¦¬ë° ë©”ì‹œì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ, ë©”ì‹œì§€ IDë“¤:\",prev.map(m=>m.id));}return updatedMessages;});// ìŠ¤íŠ¸ë¦¬ë° ì¤‘ì—ëŠ” ì‚¬ìš©ìê°€ ìŠ¤í¬ë¡¤ ì¤‘ì´ ì•„ë‹ ë•Œë§Œ ìë™ ìŠ¤í¬ë¡¤\nif(!isUserScrolling){scrollToBottom();}}else{console.log(\"currentStreamingIdê°€ nullì„\");}break;case\"stream_complete\":if(currentStreamingId){setMessages(prev=>{const updatedMessages=[...prev];const streamingMsgIndex=updatedMessages.findIndex(msg=>msg.id===currentStreamingId);if(streamingMsgIndex!==-1){updatedMessages[streamingMsgIndex]={...updatedMessages[streamingMsgIndex],content:data.fullContent,isLoading:false,isStreaming:false,timestamp:new Date().toISOString()};}return updatedMessages;});streamingMessageIdRef.current=null;scrollToBottom();}break;case\"error\":console.error(\"WebSocket ìŠ¤íŠ¸ë¦¬ë° ì˜¤ë¥˜:\",data.message);if(currentStreamingId){setMessages(prev=>{const updatedMessages=[...prev];const streamingMsgIndex=updatedMessages.findIndex(msg=>msg.id===currentStreamingId);if(streamingMsgIndex!==-1){var _data$message,_data$message2,_data$message3,_data$message4,_data$message5,_data$message6;// ì˜¤ë¥˜ ìœ í˜•ì— ë”°ë¥¸ ì‚¬ìš©ì ë©”ì‹œì§€ ê²°ì •\nlet errorContent=\"ë©”ì‹œì§€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.\";if((_data$message=data.message)!==null&&_data$message!==void 0&&_data$message.includes(\"401\")||(_data$message2=data.message)!==null&&_data$message2!==void 0&&_data$message2.includes(\"Unauthorized\")){errorContent=\"ì¸ì¦ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.\";}else if((_data$message3=data.message)!==null&&_data$message3!==void 0&&_data$message3.includes(\"timeout\")||(_data$message4=data.message)!==null&&_data$message4!==void 0&&_data$message4.includes(\"ì‹œê°„ ì´ˆê³¼\")){errorContent=\"ì²˜ë¦¬ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ìš”ì²­ì„ ë‹¨ìˆœí™”í•˜ê±°ë‚˜ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.\";}else if((_data$message5=data.message)!==null&&_data$message5!==void 0&&_data$message5.includes(\"rate limit\")||(_data$message6=data.message)!==null&&_data$message6!==void 0&&_data$message6.includes(\"ì œí•œ\")){errorContent=\"ìš”ì²­ í•œë„ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.\";}updatedMessages[streamingMsgIndex]={...updatedMessages[streamingMsgIndex],content:errorContent,isLoading:false,isStreaming:false,isError:true,timestamp:new Date().toISOString()};}return updatedMessages;});streamingMessageIdRef.current=null;}// ì‚¬ìš©ì ì¹œí™”ì ì¸ í† ìŠ¤íŠ¸ ë©”ì‹œì§€\nconst toastMessage=(_data$message7=data.message)!==null&&_data$message7!==void 0&&_data$message7.includes(\"401\")?\"ì¸ì¦ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤\":\"ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤\";toast.error(toastMessage);break;default:console.log(\"ì•Œ ìˆ˜ ì—†ëŠ” WebSocket ë©”ì‹œì§€ íƒ€ì…:\",data.type);}}catch(error){console.error(\"WebSocket ë©”ì‹œì§€ íŒŒì‹± ì˜¤ë¥˜:\",error);}};if(wsConnected){addMessageListener(handleWebSocketMessage);}return()=>{if(wsConnected){removeMessageListener(handleWebSocketMessage);}};},[wsConnected,addMessageListener,removeMessageListener,scrollToBottom]);/**\n   * ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µ ì²˜ë¦¬ í•¨ìˆ˜\n   */const handleStreamingResponse=useCallback((chunk,metadata)=>{const currentStreamingId=streamingMessageIdRef.current;console.log(\"ì²­í¬ ìˆ˜ì‹ :\",chunk,\"ìŠ¤íŠ¸ë¦¬ë° ID:\",currentStreamingId);if(!currentStreamingId){console.error(\"ìŠ¤íŠ¸ë¦¬ë° IDê°€ ì—†ìŠµë‹ˆë‹¤!\");return;}setMessages(prev=>{const updatedMessages=[...prev];const streamingMsgIndex=updatedMessages.findIndex(msg=>msg.id===currentStreamingId);if(streamingMsgIndex!==-1){// ê¸°ì¡´ ìŠ¤íŠ¸ë¦¬ë° ë©”ì‹œì§€ ì—…ë°ì´íŠ¸\nupdatedMessages[streamingMsgIndex]={...updatedMessages[streamingMsgIndex],content:updatedMessages[streamingMsgIndex].content+chunk,isLoading:true,isStreaming:true};console.log(\"ìŠ¤íŠ¸ë¦¬ë° ë©”ì‹œì§€ ì—…ë°ì´íŠ¸ ì„±ê³µ:\",updatedMessages[streamingMsgIndex].content);}else{console.error(\"ìŠ¤íŠ¸ë¦¬ë° ë©”ì‹œì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ:\",currentStreamingId);}return updatedMessages;});// ìŠ¤í¬ë¡¤ ì¡°ì • (ì‚¬ìš©ìê°€ ìŠ¤í¬ë¡¤ ì¤‘ì´ ì•„ë‹ ë•Œë§Œ)\nif(!isUserScrolling){scrollToBottom();}},[scrollToBottom,isUserScrolling]);/**\n   * ìŠ¤íŠ¸ë¦¬ë° ì™„ë£Œ ì²˜ë¦¬ í•¨ìˆ˜\n   */const handleStreamingComplete=useCallback(result=>{const currentStreamingId=streamingMessageIdRef.current;console.log(\"ìŠ¤íŠ¸ë¦¬ë° ì™„ë£Œ:\",result,\"ìŠ¤íŠ¸ë¦¬ë° ID:\",currentStreamingId);if(!currentStreamingId){console.error(\"ìŠ¤íŠ¸ë¦¬ë° ì™„ë£Œ ì²˜ë¦¬ ì¤‘ IDê°€ ì—†ìŠµë‹ˆë‹¤!\");return;}setMessages(prev=>{const updatedMessages=[...prev];const streamingMsgIndex=updatedMessages.findIndex(msg=>msg.id===currentStreamingId);if(streamingMsgIndex!==-1){// ìŠ¤íŠ¸ë¦¬ë° ë©”ì‹œì§€ ì™„ë£Œ ì²˜ë¦¬\nupdatedMessages[streamingMsgIndex]={...updatedMessages[streamingMsgIndex],content:result.result,isLoading:false,isStreaming:false,performance_metrics:result.performance_metrics,model_info:result.model_info,timestamp:new Date().toISOString()};console.log(\"ìŠ¤íŠ¸ë¦¬ë° ì™„ë£Œ ì²˜ë¦¬ ì„±ê³µ:\",updatedMessages[streamingMsgIndex].content);}else{console.error(\"ìŠ¤íŠ¸ë¦¬ë° ì™„ë£Œ ì²˜ë¦¬ ì¤‘ ë©”ì‹œì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ:\",currentStreamingId);}return updatedMessages;});// ìŠ¤íŠ¸ë¦¬ë° ID ì´ˆê¸°í™”\nstreamingMessageIdRef.current=null;// ì…ë ¥ í™œì„±í™”\nconsole.log(\"WebSocket ìŠ¤íŠ¸ë¦¬ë° ì™„ë£Œ - ì…ë ¥ í™œì„±í™”\");setCanSendMessage(true);// ìŠ¤í¬ë¡¤ ì¡°ì • (ìŠ¤íŠ¸ë¦¬ë° ì™„ë£Œ ì‹œì—ëŠ” í•­ìƒ í•˜ë‹¨ìœ¼ë¡œ)\nscrollToBottom();},[scrollToBottom]);/**\n   * ìŠ¤íŠ¸ë¦¬ë° ì¤‘ë‹¨ í•¨ìˆ˜\n   */const handleStopGeneration=useCallback(()=>{console.log(\"ìƒì„± ì¤‘ë‹¨ ìš”ì²­\");// WebSocket ì—°ê²° ì¢…ë£Œ\nif(currentWebSocketRef.current){currentWebSocketRef.current.close();currentWebSocketRef.current=null;}// í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì‘ì—… ì¤‘ë‹¨\nif(currentExecutionIdRef.current){// ì—¬ê¸°ì„œ ì‹¤ì œ API í˜¸ì¶œ ì¤‘ë‹¨ ë¡œì§ì„ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤\ncurrentExecutionIdRef.current=null;}// ìŠ¤íŠ¸ë¦¬ë° ë©”ì‹œì§€ ìƒíƒœ ì—…ë°ì´íŠ¸\nconst currentStreamingId=streamingMessageIdRef.current;if(currentStreamingId){setMessages(prev=>{const updatedMessages=[...prev];const streamingMsgIndex=updatedMessages.findIndex(msg=>msg.id===currentStreamingId);if(streamingMsgIndex!==-1){updatedMessages[streamingMsgIndex]={...updatedMessages[streamingMsgIndex],content:updatedMessages[streamingMsgIndex].content+\"\\n\\n[ìƒì„±ì´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤]\",isLoading:false,isStreaming:false,timestamp:new Date().toISOString()};}return updatedMessages;});streamingMessageIdRef.current=null;}// ì…ë ¥ ê°€ëŠ¥ ìƒíƒœë¡œ ë³µì›\nsetCanSendMessage(true);// orchestration ìƒíƒœ ë¦¬ì…‹\nresetOrchestration();toast.success(\"ìƒì„±ì´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤\");},[resetOrchestration]);/**\n   * ì…ë ¥ì°½ ë†’ì´ ìë™ ì¡°ì ˆ\n   */const adjustInputHeight=useCallback(value=>{if(!value.trim()){setInputHeight(24);// ê¸°ë³¸ ë†’ì´\nreturn;}// ì¤„ ìˆ˜ ê³„ì‚° (ëŒ€ëµì )\nconst lines=value.split(\"\\n\").length;const charBasedLines=Math.ceil(value.length/80);// 80ìë‹¹ 1ì¤„ë¡œ ì¶”ì •\nconst estimatedLines=Math.max(lines,charBasedLines);// ë†’ì´ ê³„ì‚° (lineHeight: 1.4, fontSize: 16px)\nlet calculatedHeight;if(estimatedLines<=3){calculatedHeight=24+(estimatedLines-1)*22;// ê¸°ë³¸ + ì¶”ê°€ ì¤„\n}else if(estimatedLines<=10){calculatedHeight=150+(estimatedLines-6)*15;// ì¤‘ê°„ ë²”ìœ„\n}else{calculatedHeight=Math.min(400,150+(estimatedLines-6)*12);// ìµœëŒ€ 400px\n}setInputHeight(Math.max(24,calculatedHeight));},[]);/**\n   * ì…ë ¥ê°’ ë³€ê²½ ì²˜ë¦¬\n   */const handleInputChange=useCallback(value=>{setInputValue(value);adjustInputHeight(value);},[adjustInputHeight]);/**\n   * ë©”ì‹œì§€ ì „ì†¡\n   */const handleSendMessage=useCallback(async()=>{console.log(\"í•´ë“¤ ì „ì†¡ í˜¸ì¶œ:\",{inputValue:inputValue.trim(),isGenerating,canSendMessage});if(!inputValue.trim()||isGenerating){console.log(\"ì „ì†¡ ì¤‘ë‹¨: ì¡°ê±´ ë¶€ì¡±\");return;}// ì…ë ¥ ë¹„í™œì„±í™”\nconsole.log(\"ì…ë ¥ ë¹„í™œì„±í™”\");setCanSendMessage(false);const userMessage={id:\"user-\"+Date.now(),type:\"user\",content:inputValue.trim(),timestamp:new Date().toISOString()};// ìŠ¤íŠ¸ë¦¬ë° ë©”ì‹œì§€ ID ìƒì„±\nconst streamMsgId=\"streaming-\"+Date.now();streamingMessageIdRef.current=streamMsgId;console.log(\"ìƒˆ ìŠ¤íŠ¸ë¦¬ë° ë©”ì‹œì§€ ID ìƒì„±:\",streamMsgId);// ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µì„ ìœ„í•œ ì´ˆê¸° ë©”ì‹œì§€\nconst streamingMessage={id:streamMsgId,type:\"assistant\",content:\"\",timestamp:new Date().toISOString(),isLoading:true,isStreaming:true};setMessages(prev=>[...prev,userMessage,streamingMessage]);setInputValue(\"\");setInputHeight(24);// ì…ë ¥ì°½ ë†’ì´ ì´ˆê¸°í™”\n// ê¸°ì¡´ ë©”ì‹œì§€ + í˜„ì¬ ì‚¬ìš©ì ë©”ì‹œì§€ë¥¼ í¬í•¨í•œ ëŒ€í™” íˆìŠ¤í† ë¦¬ ìƒì„±\nconst allMessages=[...messages,userMessage];const chatHistory=allMessages.filter(msg=>!msg.isLoading&&!msg.isError&&!msg.isStreaming).map(msg=>({role:msg.type===\"user\"?\"user\":\"assistant\",content:msg.content}));// ìµœëŒ€ ëŒ€í™” ê¸°ì–µ ì„¤ì • (ìµœê·¼ 50ê°œ ë©”ì‹œì§€ë¡œ ìµœëŒ€ ë©”ëª¨ë¦¬ ìœ ì§€)\nconst maxHistoryLength=50;const trimmedChatHistory=chatHistory.slice(-maxHistoryLength);console.log(\"ëŒ€í™” íˆìŠ¤í† ë¦¬ ìƒì„±:\",{totalMessages:allMessages.length,fullHistoryLength:chatHistory.length,trimmedHistoryLength:trimmedChatHistory.length,maxHistoryLength:maxHistoryLength,recentHistory:trimmedChatHistory.slice(-6)// ìµœê·¼ 6ê°œë§Œ ë¡œê·¸ì— í‘œì‹œ\n});try{// í”„ë¡¬í”„íŠ¸ ì¹´ë“œ ì •ë³´ ì¶”ê°€ - í™œì„±í™”ëœ ì¹´ë“œë§Œ í•„í„°ë§í•˜ê³  ë°±ì—”ë“œ í˜•ì‹ì— ë§ê²Œ ë³€í™˜\nconst safePromptCards=Array.isArray(promptCards)?promptCards:[];const activePromptCards=safePromptCards.filter(card=>card.isActive!==false&&card.enabled!==false).map(card=>({promptId:card.promptId||card.prompt_id,title:card.title||\"Untitled\",prompt_text:card.prompt_text||card.content||\"\",tags:card.tags||[],isActive:card.isActive!==false,stepOrder:card.stepOrder||0})).filter(card=>card.prompt_text.trim())// í”„ë¡¬í”„íŠ¸ ë‚´ìš©ì´ ìˆëŠ” ê²ƒë§Œ\n.sort((a,b)=>(a.stepOrder||0)-(b.stepOrder||0));// stepOrderë¡œ ì •ë ¬\nconsole.log(\"ëŒ€í™” ì „ì†¡ ë°ì´í„° í™•ì¸:\",{messageContent:userMessage.content,chatHistoryLength:trimmedChatHistory.length,promptCardsCount:activePromptCards.length,chatHistory:trimmedChatHistory,promptCards:activePromptCards.map(card=>({id:card.promptId,title:card.title,contentLength:card.prompt_text.length,stepOrder:card.stepOrder,hasContent:!!card.prompt_text.trim()}))});// WebSocket ì—°ê²° í™•ì¸ ë° ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë° ì‹œë„\nif(wsConnected){console.log(\"WebSocketì„ í†µí•œ ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë° ì‹œì‘\");console.log(\"ğŸ” [DEBUG] ìŠ¤íŠ¸ë¦¬ë° ë§¤ê°œë³€ìˆ˜ ìƒì„¸ í™•ì¸:\",{projectId,userInput:userMessage.content,conversationId:conversationId,userSub:user===null||user===void 0?void 0:user.id,historyLength:trimmedChatHistory.length,promptCardsLength:activePromptCards.length,conversationIdType:typeof conversationId,conversationIdValue:conversationId,isConversationIdNull:conversationId===null,isConversationIdUndefined:conversationId===undefined});const success=wsStartStreaming(userMessage.content,trimmedChatHistory,activePromptCards,selectedModel,conversationId,// Add conversationId\nuser===null||user===void 0?void 0:user.id// Add userSub from AuthContext\n);if(success){// WebSocket ìŠ¤íŠ¸ë¦¬ë° ì„±ê³µ, ë‚˜ë¨¸ì§€ëŠ” ë¦¬ìŠ¤ë„ˆì—ì„œ ì²˜ë¦¬\nreturn;}else{console.log(\"WebSocket ì „ì†¡ ì‹¤íŒ¨, SSE í´ë°± ëª¨ë“œë¡œ ì „í™˜\");}}else{console.log(\"WebSocket ë¯¸ì—°ê²°, SSE ëª¨ë“œ ì‚¬ìš©\");}// ğŸŒŸ ë©€í‹°-ì—ì´ì „íŠ¸ ì‹œìŠ¤í…œ ì‹¤í–‰\nconsole.log(\"ë©€í‹°-ì—ì´ì „íŠ¸ ì‹œìŠ¤í…œ ì‹¤í–‰ ì‹œì‘\");// 1. ë¨¼ì € í”„ë¡¬í”„íŠ¸ ì¹´ë“œë“¤ì„ crew ì¸ìŠ¤í„´ìŠ¤ë¡œ ìƒì„±\nif(activePromptCards.length>0){try{console.log(\"í”„ë¡¬í”„íŠ¸ ì¹´ë“œ â†’ í¬ë£¨ ì¸ìŠ¤í„´ìŠ¤ ë³€í™˜ ì‹œë„\");await crewAPI.createCrewInstance(projectId,activePromptCards);console.log(\"í¬ë£¨ ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ì™„ë£Œ\");}catch(instanceError){var _instanceError$respon;console.log(\"í¬ë£¨ ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ì‹¤íŒ¨:\",instanceError.message);// 401 ì¸ì¦ ì˜¤ë¥˜ì¸ ê²½ìš° ì²˜ë¦¬ ì¤‘ë‹¨\nif(((_instanceError$respon=instanceError.response)===null||_instanceError$respon===void 0?void 0:_instanceError$respon.status)===401){const{shouldRedirect}=await handleAPIError(instanceError);if(shouldRedirect){return;}}// ë‹¤ë¥¸ ì˜¤ë¥˜ëŠ” ë¡œê·¸ë§Œ ë‚¨ê¸°ê³  ê³„ì† ì§„í–‰ (ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ê²½ìš° ë“±)\nconsole.log(\"í¬ë£¨ ì¸ìŠ¤í„´ìŠ¤ ê´€ë ¨ ì˜¤ë¥˜ì´ì§€ë§Œ ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤\");}}// 2. ë©€í‹°-ì—ì´ì „íŠ¸ ë³‘ë ¬ ì‹¤í–‰\nconst multiAgentResult=await crewAPI.executeMultiAgent(projectId,userMessage.content,progress=>{// ì§„í–‰ìƒí™© ì—…ë°ì´íŠ¸ (ì˜µì…˜)\nconsole.log(\"ë©€í‹°-ì—ì´ì „íŠ¸ ì§„í–‰ìƒí™©:\",progress);});console.log(\"ë©€í‹°-ì—ì´ì „íŠ¸ ì‹¤í–‰ ì™„ë£Œ:\",multiAgentResult);// 3. ê²°ê³¼ë¥¼ UI ë©”ì‹œì§€ë¡œ ë³€í™˜\nconst assistantMessage=processMultiAgentResponse(multiAgentResult);// 4. ìŠ¤íŠ¸ë¦¬ë° ë©”ì‹œì§€ë¥¼ ìµœì¢… ê²°ê³¼ë¡œ êµì²´\nsetMessages(prev=>{const updatedMessages=[...prev];const streamingMsgIndex=updatedMessages.findIndex(msg=>msg.id===streamingMessageIdRef.current);if(streamingMsgIndex!==-1){updatedMessages[streamingMsgIndex]=assistantMessage;}else{updatedMessages.push(assistantMessage);}return updatedMessages;});streamingMessageIdRef.current=null;setCanSendMessage(true);// ì„±ê³µ í† ìŠ¤íŠ¸\ntoast.success(`${Object.keys(multiAgentResult.agentResults||{}).length}ê°œ ì—ì´ì „íŠ¸ ë¶„ì„ ì™„ë£Œ!`);}catch(error){var _error$response;console.error(\"ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨:\",error);// API ì˜¤ë¥˜ ì²˜ë¦¬ ìœ„ì„\nconst{userMessage:errorUserMessage,shouldRedirect}=await handleAPIError(error);// ì¸ì¦ ì˜¤ë¥˜ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ê°€ í•„ìš”í•œ ê²½ìš°\nif(shouldRedirect){return;}const errorMessage={id:\"error-\"+Date.now(),type:\"assistant\",content:errorUserMessage,timestamp:new Date().toISOString(),isError:true,errorDetails:{message:error.message,status:(_error$response=error.response)===null||_error$response===void 0?void 0:_error$response.status,code:error.code}};setMessages(prev=>{// ìŠ¤íŠ¸ë¦¬ë° ë©”ì‹œì§€ë¥¼ ì°¾ì•„ ì œê±°\nconst currentStreamingId=streamingMessageIdRef.current;const filteredMessages=prev.filter(msg=>msg.id!==currentStreamingId);return[...filteredMessages,errorMessage];});streamingMessageIdRef.current=null;// ì˜¤ë¥˜ ë°œìƒ ì‹œë„ ì…ë ¥ í™œì„±í™”\nsetCanSendMessage(true);}// ì „ì²´ ì „ì†¡ ê³¼ì • ì™„ë£Œ í›„ ì…ë ¥ í™œì„±í™” (ë³´í—˜ìš©)\nsetCanSendMessage(true);},[inputValue,isGenerating,executeOrchestration,handleStreamingResponse,handleStreamingComplete,messages]);/**\n   * Enter í‚¤ë¡œ ì „ì†¡\n   */const handleKeyPress=useCallback(e=>{if(e.key===\"Enter\"&&!e.shiftKey){e.preventDefault();handleSendMessage();}},[handleSendMessage]);/**\n   * ë©”ì‹œì§€ ë³µì‚¬\n   */const handleCopyMessage=useCallback(async(content,messageId)=>{const success=await copyToClipboard(content);if(success){setCopiedMessage(messageId);setTimeout(()=>setCopiedMessage(null),2000);}},[]);/**\n   * ê°œë³„ ì œëª© ë³µì‚¬\n   */const handleCopyTitle=useCallback(async(title,messageId,index)=>{const success=await copyToClipboard(title,\"ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\");if(success){setCopiedMessage(`${messageId}_title_${index}`);setTimeout(()=>setCopiedMessage(null),2000);}},[]);/**\n   * ì±„íŒ… ì´ˆê¸°í™”\n   */const resetChat=useCallback(()=>{setMessages([]);setInputValue(\"\");setCopiedMessage(null);setCanSendMessage(true);streamingMessageIdRef.current=null;currentWebSocketRef.current=null;currentExecutionIdRef.current=null;resetOrchestration();},[resetOrchestration]);return{messages,inputValue,setInputValue,handleInputChange,// ìƒˆë¡œìš´ ì…ë ¥ í•¸ë“¤ëŸ¬\ncopiedMessage,isGenerating,isStreaming,canSendMessage,streamingMessageId:streamingMessageIdRef.current,messagesEndRef,inputRef,inputHeight,// ë™ì  ë†’ì´\nhandleSendMessage,handleStopGeneration,handleKeyPress,handleCopyMessage,handleCopyTitle,resetChat,scrollToBottom,// WebSocket ìƒíƒœ ì¶”ê°€\nwsConnected,wsConnecting,wsError,// ìŠ¤í¬ë¡¤ ê´€ë ¨ ì¶”ê°€\nscrollContainerRef,handleScroll,isUserScrolling,// ëª¨ë¸ ì„ íƒ ê´€ë ¨ ì¶”ê°€\nselectedModel,setSelectedModel};};","map":{"version":3,"names":["useState","useEffect","useRef","useCallback","toast","copyToClipboard","useOrchestration","useWebSocket","crewAPI","handleAPIError","useAuth","processMultiAgentResponse","result","console","error","id","Date","now","type","content","timestamp","toISOString","isError","agentResults","finalTitles","tokenUsage","agentSummary","Object","keys","map","agentType","agentResult","titles","agentName","getAgentName","tokenCount","allTitles","values","flat","formatMultiAgentContent","isMultiAgent","agentNames","journalism","balanced","click","seo","social","length","forEach","title","index","agent","useChat","projectId","projectName","promptCards","arguments","undefined","conversationId","user","isFirstRender","current","log","promptCardsLength","conversationIdType","isConversationIdNull","isConversationIdUndefined","userId","newConversationId","isNull","isUndefined","messages","setMessages","inputValue","setInputValue","copiedMessage","setCopiedMessage","canSendMessage","setCanSendMessage","inputHeight","setInputHeight","selectedModel","setSelectedModel","streamingMessageIdRef","currentWebSocketRef","currentExecutionIdRef","messagesEndRef","inputRef","isUserScrolling","setIsUserScrolling","scrollContainerRef","lastScrollTopRef","isExecuting","isGenerating","isStreaming","executeOrchestration","resetOrchestration","isConnected","wsConnected","isConnecting","wsConnecting","wsError","startStreaming","wsStartStreaming","addMessageListener","removeMessageListener","handleScroll","container","currentScrollTop","scrollTop","maxScrollTop","scrollHeight","clientHeight","Math","abs","isAtBottom","scrollToBottom","scrollIntoView","behavior","handleWebSocketMessage","event","_data$message7","data","JSON","parse","currentStreamingId","step","progress","prev","updatedMessages","streamingMsgIndex","findIndex","msg","messagesLength","currentContent","isLoading","m","fullContent","message","_data$message","_data$message2","_data$message3","_data$message4","_data$message5","_data$message6","errorContent","includes","toastMessage","handleStreamingResponse","chunk","metadata","handleStreamingComplete","performance_metrics","model_info","handleStopGeneration","close","success","adjustInputHeight","value","trim","lines","split","charBasedLines","ceil","estimatedLines","max","calculatedHeight","min","handleInputChange","handleSendMessage","userMessage","streamMsgId","streamingMessage","allMessages","chatHistory","filter","role","maxHistoryLength","trimmedChatHistory","slice","totalMessages","fullHistoryLength","trimmedHistoryLength","recentHistory","safePromptCards","Array","isArray","activePromptCards","card","isActive","enabled","promptId","prompt_id","prompt_text","tags","stepOrder","sort","a","b","messageContent","chatHistoryLength","promptCardsCount","contentLength","hasContent","userInput","userSub","historyLength","conversationIdValue","createCrewInstance","instanceError","_instanceError$respon","response","status","shouldRedirect","multiAgentResult","executeMultiAgent","assistantMessage","push","_error$response","errorUserMessage","errorMessage","errorDetails","code","filteredMessages","handleKeyPress","e","key","shiftKey","preventDefault","handleCopyMessage","messageId","setTimeout","handleCopyTitle","resetChat","streamingMessageId"],"sources":["/Users/yeong-gwang/Documents/work/á„‰á…¥á„‹á…®á†¯á„€á…§á†¼á„Œá…¦á„‰á…µá†«á„†á…®á†«/dev/nexus/title_generator_ver1/frontend/src/hooks/useChat.js"],"sourcesContent":["import { useState, useEffect, useRef, useCallback } from \"react\";\nimport { toast } from \"react-hot-toast\";\nimport { copyToClipboard } from \"../utils/clipboard\";\nimport { useOrchestration } from \"./useOrchestration\";\nimport { useWebSocket } from \"./useWebSocket\";\nimport { crewAPI, handleAPIError } from \"../services/api\";\nimport { useAuth } from \"../contexts/AuthContext\";\n\n/**\n * ë©€í‹°-ì—ì´ì „íŠ¸ AI ì‘ë‹µì„ íŒŒì‹±í•˜ê³  UIì— ë§ëŠ” ë©”ì‹œì§€ ê°ì²´ë¡œ ë³€í™˜\n */\nconst processMultiAgentResponse = (result) => {\n  if (!result) {\n    console.error(\"ë©€í‹°-ì—ì´ì „íŠ¸ ì‘ë‹µ ì˜¤ë¥˜: ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤\", result);\n    return {\n      id: \"error-\" + Date.now(),\n      type: \"assistant\",\n      content: \"ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.\",\n      timestamp: new Date().toISOString(),\n      isError: true,\n    };\n  }\n\n  // ë©€í‹°-ì—ì´ì „íŠ¸ ê²°ê³¼ êµ¬ì„±\n  const agentResults = result.agentResults || {};\n  const finalTitles = result.finalTitles || {};\n  const tokenUsage = result.tokenUsage || 0;\n\n  // ì—ì´ì „íŠ¸ë³„ ê²°ê³¼ë¥¼ í¬ë§·íŒ…\n  const agentSummary = Object.keys(agentResults).map((agentType) => {\n    const agentResult = agentResults[agentType];\n    const titles = finalTitles[agentType] || [];\n\n    return {\n      agentType,\n      agentName: getAgentName(agentType),\n      result: agentResult?.content || \"ê²°ê³¼ ì—†ìŒ\",\n      titles: titles,\n      tokenCount: agentResult?.tokenCount || 0,\n    };\n  });\n\n  // ì „ì²´ ì œëª© ëª©ë¡ ìƒì„±\n  const allTitles = Object.values(finalTitles).flat();\n\n  return {\n    id: \"multi-agent-\" + Date.now(),\n    type: \"assistant\",\n    content: formatMultiAgentContent(agentSummary, allTitles),\n    timestamp: new Date(),\n    // ë©€í‹°-ì—ì´ì „íŠ¸ íŠ¹í™” ë°ì´í„°\n    isMultiAgent: true,\n    agentResults: agentSummary,\n    allTitles: allTitles,\n    tokenUsage: tokenUsage,\n  };\n};\n\n/**\n * ì—ì´ì „íŠ¸ íƒ€ì…ì„ í•œêµ­ì–´ ì´ë¦„ìœ¼ë¡œ ë³€í™˜\n */\nconst getAgentName = (agentType) => {\n  const agentNames = {\n    journalism: \"ğŸ“° ì €ë„ë¦¬ì¦˜ ì¶©ì‹¤í˜•\",\n    balanced: \"âš–ï¸ ê· í˜•ì¡íŒ í›„í‚¹í˜•\",\n    click: \"ğŸ¯ í´ë¦­ìœ ë„í˜•\",\n    seo: \"ğŸ” SEO/AEO ìµœì í™”í˜•\",\n    social: \"ğŸ“± ì†Œì…œë¯¸ë””ì–´ ê³µìœ í˜•\",\n  };\n  return agentNames[agentType] || `ğŸ¤– ${agentType}`;\n};\n\n/**\n * ë©€í‹°-ì—ì´ì „íŠ¸ ê²°ê³¼ë¥¼ UI í‘œì‹œìš© í…ìŠ¤íŠ¸ë¡œ í¬ë§·íŒ…\n */\nconst formatMultiAgentContent = (agentSummary, allTitles) => {\n  let content = \"ğŸš€ **ë©€í‹°-ì—ì´ì „íŠ¸ ë¶„ì„ ì™„ë£Œ**\\n\\n\";\n\n  // ì „ì²´ ì œëª© ìš”ì•½\n  if (allTitles.length > 0) {\n    content += \"ğŸ“‹ **ìƒì„±ëœ ì œëª© ëª©ë¡:**\\n\";\n    allTitles.forEach((title, index) => {\n      content += `${index + 1}. ${title}\\n`;\n    });\n    content += \"\\n\";\n  }\n\n  // ì—ì´ì „íŠ¸ë³„ ìƒì„¸ ê²°ê³¼\n  content += \"ğŸ” **ì—ì´ì „íŠ¸ë³„ ë¶„ì„ ê²°ê³¼:**\\n\\n\";\n  agentSummary.forEach((agent) => {\n    content += `### ${agent.agentName}\\n`;\n    if (agent.titles.length > 0) {\n      content += \"**ìƒì„± ì œëª©:**\\n\";\n      agent.titles.forEach((title) => {\n        content += `â€¢ ${title}\\n`;\n      });\n    }\n    content += `**í† í° ì‚¬ìš©ëŸ‰:** ${agent.tokenCount}ê°œ\\n\\n`;\n  });\n\n  return content;\n};\n\n/**\n * ì±„íŒ… ê¸°ëŠ¥ì„ ìœ„í•œ ì»¤ìŠ¤í…€ í›…\n * @param {string} projectId - í”„ë¡œì íŠ¸ ID\n * @param {string} projectName - í”„ë¡œì íŠ¸ ì´ë¦„\n * @param {Array} promptCards - í”„ë¡¬í”„íŠ¸ ì¹´ë“œ ë°°ì—´\n * @returns {Object} - ì±„íŒ… ê´€ë ¨ ìƒíƒœì™€ í•¨ìˆ˜ë“¤\n */\nexport const useChat = (\n  projectId,\n  projectName,\n  promptCards = [],\n  conversationId = null\n) => {\n  const { user } = useAuth(); // Add user from AuthContext\n\n  // ë””ë²„ê¹… ë¡œê·¸ (ì²« ë²ˆì§¸ ë Œë”ë§ì—ë§Œ)\n  const isFirstRender = useRef(true);\n  if (isFirstRender.current) {\n    console.log(\"ğŸ” [DEBUG] useChat ì´ˆê¸°í™”:\", {\n      projectId,\n      projectName,\n      promptCardsLength: promptCards?.length,\n      conversationId,\n      conversationIdType: typeof conversationId,\n      isConversationIdNull: conversationId === null,\n      isConversationIdUndefined: conversationId === undefined,\n      userId: user?.id,\n    });\n    isFirstRender.current = false;\n  }\n  \n  // conversationId ë³€ê²½ ê°ì§€\n  useEffect(() => {\n    console.log(\"ğŸ” [DEBUG] useChat - conversationId ë³€ê²½:\", {\n      newConversationId: conversationId,\n      conversationIdType: typeof conversationId,\n      isNull: conversationId === null,\n      isUndefined: conversationId === undefined,\n    });\n  }, [conversationId]);\n  const [messages, setMessages] = useState([]);\n  const [inputValue, setInputValue] = useState(\"\");\n  const [copiedMessage, setCopiedMessage] = useState(null);\n  const [canSendMessage, setCanSendMessage] = useState(true);\n  const [inputHeight, setInputHeight] = useState(24); // ë™ì  ë†’ì´ ê´€ë¦¬\n  const [selectedModel, setSelectedModel] = useState(\n    \"anthropic.claude-3-5-sonnet-20241022-v2:0\"\n  );\n  const streamingMessageIdRef = useRef(null);\n  const currentWebSocketRef = useRef(null);\n  const currentExecutionIdRef = useRef(null);\n\n  const messagesEndRef = useRef(null);\n  const inputRef = useRef(null);\n\n  // ì‚¬ìš©ì ìŠ¤í¬ë¡¤ ìƒíƒœ ì¶”ì \n  const [isUserScrolling, setIsUserScrolling] = useState(false);\n  const scrollContainerRef = useRef(null);\n  const lastScrollTopRef = useRef(0);\n\n  const {\n    isExecuting: isGenerating,\n    isStreaming,\n    executeOrchestration,\n    resetOrchestration,\n  } = useOrchestration(projectId);\n\n  // WebSocket í›… ì¶”ê°€\n  const {\n    isConnected: wsConnected,\n    isConnecting: wsConnecting,\n    error: wsError,\n    startStreaming: wsStartStreaming,\n    addMessageListener,\n    removeMessageListener,\n  } = useWebSocket(projectId);\n\n  // ì´ˆê¸° ë©”ì‹œì§€ ì„¤ì • - projectId ë³€ê²½ì‹œì—ë§Œ ì´ˆê¸°í™”\n  useEffect(() => {\n    setMessages([]); // ë¹ˆ ë°°ì—´ë¡œ ì‹œì‘\n  }, [projectId]); // projectName ëŒ€ì‹  projectId ì‚¬ìš©\n\n  // ì‚¬ìš©ì ìŠ¤í¬ë¡¤ ê°ì§€ í•¨ìˆ˜\n  const handleScroll = useCallback(() => {\n    if (!scrollContainerRef.current) return;\n\n    const container = scrollContainerRef.current;\n    const currentScrollTop = container.scrollTop;\n    const maxScrollTop = container.scrollHeight - container.clientHeight;\n\n    // ì‚¬ìš©ìê°€ ìˆ˜ë™ìœ¼ë¡œ ìŠ¤í¬ë¡¤í–ˆëŠ”ì§€ ê°ì§€\n    if (Math.abs(currentScrollTop - lastScrollTopRef.current) > 2) {\n      const isAtBottom = currentScrollTop >= maxScrollTop - 20;\n\n      // í•˜ë‹¨ì— ìˆì„ ë•Œë§Œ ìë™ ìŠ¤í¬ë¡¤ í—ˆìš©, ê·¸ ì™¸ëŠ” ì‚¬ìš©ì ìŠ¤í¬ë¡¤ ëª¨ë“œ\n      setIsUserScrolling(!isAtBottom);\n    }\n\n    lastScrollTopRef.current = currentScrollTop;\n  }, []);\n\n  const scrollToBottom = useCallback(() => {\n    // ì‚¬ìš©ìê°€ ìŠ¤í¬ë¡¤ ì¤‘ì´ ì•„ë‹ ë•Œë§Œ ìë™ ìŠ¤í¬ë¡¤\n    if (!isUserScrolling && messagesEndRef.current) {\n      messagesEndRef.current.scrollIntoView({ behavior: \"smooth\" });\n    }\n  }, [isUserScrolling]);\n\n  // ë©”ì‹œì§€ ì¶”ê°€ ì‹œ ìŠ¤í¬ë¡¤ í•˜ë‹¨ìœ¼ë¡œ (ì‚¬ìš©ì ìŠ¤í¬ë¡¤ ì¤‘ì´ ì•„ë‹ ë•Œë§Œ)\n  useEffect(() => {\n    scrollToBottom();\n  }, [messages, scrollToBottom]);\n\n  // WebSocket ë©”ì‹œì§€ ë¦¬ìŠ¤ë„ˆ ì„¤ì •\n  useEffect(() => {\n    const handleWebSocketMessage = (event) => {\n      try {\n        const data = JSON.parse(event.data);\n        console.log(\"WebSocket ë©”ì‹œì§€ ìˆ˜ì‹ :\", data);\n\n        const currentStreamingId = streamingMessageIdRef.current;\n\n        switch (data.type) {\n          case \"stream_start\":\n            console.log(\"WebSocket ìŠ¤íŠ¸ë¦¬ë° ì‹œì‘\");\n            break;\n\n          case \"progress\":\n            // ì§„í–‰ ìƒí™© ë¡œê·¸ë§Œ ë‚¨ê¸°ê³  UI ì—…ë°ì´íŠ¸ëŠ” ì œê±°\n            console.log(`ì§„í–‰ ìƒí™©: ${data.step} (${data.progress}%)`);\n            break;\n\n          case \"stream_chunk\":\n            if (currentStreamingId) {\n              setMessages((prev) => {\n                const updatedMessages = [...prev];\n                const streamingMsgIndex = updatedMessages.findIndex(\n                  (msg) => msg.id === currentStreamingId\n                );\n\n                console.log(\"ìŠ¤íŠ¸ë¦¼ ì²­í¬ ì²˜ë¦¬:\", {\n                  currentStreamingId,\n                  streamingMsgIndex,\n                  messagesLength: prev.length,\n                  content: data.content,\n                });\n\n                if (streamingMsgIndex !== -1) {\n                  // ê¸°ì¡´ ë‚´ìš©ì— ìƒˆ ì²­í¬ ì¶”ê°€\n                  const currentContent =\n                    updatedMessages[streamingMsgIndex].content || \"\";\n\n                  updatedMessages[streamingMsgIndex] = {\n                    ...updatedMessages[streamingMsgIndex],\n                    content: currentContent + data.content,\n                    isLoading: true,\n                    isStreaming: true,\n                  };\n\n                  console.log(\n                    \"ë©”ì‹œì§€ ì—…ë°ì´íŠ¸ë¨:\",\n                    updatedMessages[streamingMsgIndex]\n                  );\n                } else {\n                  console.log(\n                    \"ìŠ¤íŠ¸ë¦¬ë° ë©”ì‹œì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ, ë©”ì‹œì§€ IDë“¤:\",\n                    prev.map((m) => m.id)\n                  );\n                }\n\n                return updatedMessages;\n              });\n              // ìŠ¤íŠ¸ë¦¬ë° ì¤‘ì—ëŠ” ì‚¬ìš©ìê°€ ìŠ¤í¬ë¡¤ ì¤‘ì´ ì•„ë‹ ë•Œë§Œ ìë™ ìŠ¤í¬ë¡¤\n              if (!isUserScrolling) {\n                scrollToBottom();\n              }\n            } else {\n              console.log(\"currentStreamingIdê°€ nullì„\");\n            }\n            break;\n\n          case \"stream_complete\":\n            if (currentStreamingId) {\n              setMessages((prev) => {\n                const updatedMessages = [...prev];\n                const streamingMsgIndex = updatedMessages.findIndex(\n                  (msg) => msg.id === currentStreamingId\n                );\n\n                if (streamingMsgIndex !== -1) {\n                  updatedMessages[streamingMsgIndex] = {\n                    ...updatedMessages[streamingMsgIndex],\n                    content: data.fullContent,\n                    isLoading: false,\n                    isStreaming: false,\n                    timestamp: new Date().toISOString(),\n                  };\n                }\n\n                return updatedMessages;\n              });\n              streamingMessageIdRef.current = null;\n              scrollToBottom();\n            }\n            break;\n\n          case \"error\":\n            console.error(\"WebSocket ìŠ¤íŠ¸ë¦¬ë° ì˜¤ë¥˜:\", data.message);\n            if (currentStreamingId) {\n              setMessages((prev) => {\n                const updatedMessages = [...prev];\n                const streamingMsgIndex = updatedMessages.findIndex(\n                  (msg) => msg.id === currentStreamingId\n                );\n\n                if (streamingMsgIndex !== -1) {\n                  // ì˜¤ë¥˜ ìœ í˜•ì— ë”°ë¥¸ ì‚¬ìš©ì ë©”ì‹œì§€ ê²°ì •\n                  let errorContent =\n                    \"ë©”ì‹œì§€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.\";\n\n                  if (\n                    data.message?.includes(\"401\") ||\n                    data.message?.includes(\"Unauthorized\")\n                  ) {\n                    errorContent =\n                      \"ì¸ì¦ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.\";\n                  } else if (\n                    data.message?.includes(\"timeout\") ||\n                    data.message?.includes(\"ì‹œê°„ ì´ˆê³¼\")\n                  ) {\n                    errorContent =\n                      \"ì²˜ë¦¬ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ìš”ì²­ì„ ë‹¨ìˆœí™”í•˜ê±°ë‚˜ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.\";\n                  } else if (\n                    data.message?.includes(\"rate limit\") ||\n                    data.message?.includes(\"ì œí•œ\")\n                  ) {\n                    errorContent =\n                      \"ìš”ì²­ í•œë„ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.\";\n                  }\n\n                  updatedMessages[streamingMsgIndex] = {\n                    ...updatedMessages[streamingMsgIndex],\n                    content: errorContent,\n                    isLoading: false,\n                    isStreaming: false,\n                    isError: true,\n                    timestamp: new Date().toISOString(),\n                  };\n                }\n\n                return updatedMessages;\n              });\n              streamingMessageIdRef.current = null;\n            }\n\n            // ì‚¬ìš©ì ì¹œí™”ì ì¸ í† ìŠ¤íŠ¸ ë©”ì‹œì§€\n            const toastMessage = data.message?.includes(\"401\")\n              ? \"ì¸ì¦ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤\"\n              : \"ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤\";\n            toast.error(toastMessage);\n            break;\n\n          default:\n            console.log(\"ì•Œ ìˆ˜ ì—†ëŠ” WebSocket ë©”ì‹œì§€ íƒ€ì…:\", data.type);\n        }\n      } catch (error) {\n        console.error(\"WebSocket ë©”ì‹œì§€ íŒŒì‹± ì˜¤ë¥˜:\", error);\n      }\n    };\n\n    if (wsConnected) {\n      addMessageListener(handleWebSocketMessage);\n    }\n\n    return () => {\n      if (wsConnected) {\n        removeMessageListener(handleWebSocketMessage);\n      }\n    };\n  }, [wsConnected, addMessageListener, removeMessageListener, scrollToBottom]);\n\n  /**\n   * ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µ ì²˜ë¦¬ í•¨ìˆ˜\n   */\n  const handleStreamingResponse = useCallback(\n    (chunk, metadata) => {\n      const currentStreamingId = streamingMessageIdRef.current;\n\n      console.log(\"ì²­í¬ ìˆ˜ì‹ :\", chunk, \"ìŠ¤íŠ¸ë¦¬ë° ID:\", currentStreamingId);\n\n      if (!currentStreamingId) {\n        console.error(\"ìŠ¤íŠ¸ë¦¬ë° IDê°€ ì—†ìŠµë‹ˆë‹¤!\");\n        return;\n      }\n\n      setMessages((prev) => {\n        const updatedMessages = [...prev];\n        const streamingMsgIndex = updatedMessages.findIndex(\n          (msg) => msg.id === currentStreamingId\n        );\n\n        if (streamingMsgIndex !== -1) {\n          // ê¸°ì¡´ ìŠ¤íŠ¸ë¦¬ë° ë©”ì‹œì§€ ì—…ë°ì´íŠ¸\n          updatedMessages[streamingMsgIndex] = {\n            ...updatedMessages[streamingMsgIndex],\n            content: updatedMessages[streamingMsgIndex].content + chunk,\n            isLoading: true,\n            isStreaming: true,\n          };\n          console.log(\n            \"ìŠ¤íŠ¸ë¦¬ë° ë©”ì‹œì§€ ì—…ë°ì´íŠ¸ ì„±ê³µ:\",\n            updatedMessages[streamingMsgIndex].content\n          );\n        } else {\n          console.error(\"ìŠ¤íŠ¸ë¦¬ë° ë©”ì‹œì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ:\", currentStreamingId);\n        }\n\n        return updatedMessages;\n      });\n\n      // ìŠ¤í¬ë¡¤ ì¡°ì • (ì‚¬ìš©ìê°€ ìŠ¤í¬ë¡¤ ì¤‘ì´ ì•„ë‹ ë•Œë§Œ)\n      if (!isUserScrolling) {\n        scrollToBottom();\n      }\n    },\n    [scrollToBottom, isUserScrolling]\n  );\n\n  /**\n   * ìŠ¤íŠ¸ë¦¬ë° ì™„ë£Œ ì²˜ë¦¬ í•¨ìˆ˜\n   */\n  const handleStreamingComplete = useCallback(\n    (result) => {\n      const currentStreamingId = streamingMessageIdRef.current;\n\n      console.log(\"ìŠ¤íŠ¸ë¦¬ë° ì™„ë£Œ:\", result, \"ìŠ¤íŠ¸ë¦¬ë° ID:\", currentStreamingId);\n\n      if (!currentStreamingId) {\n        console.error(\"ìŠ¤íŠ¸ë¦¬ë° ì™„ë£Œ ì²˜ë¦¬ ì¤‘ IDê°€ ì—†ìŠµë‹ˆë‹¤!\");\n        return;\n      }\n\n      setMessages((prev) => {\n        const updatedMessages = [...prev];\n        const streamingMsgIndex = updatedMessages.findIndex(\n          (msg) => msg.id === currentStreamingId\n        );\n\n        if (streamingMsgIndex !== -1) {\n          // ìŠ¤íŠ¸ë¦¬ë° ë©”ì‹œì§€ ì™„ë£Œ ì²˜ë¦¬\n          updatedMessages[streamingMsgIndex] = {\n            ...updatedMessages[streamingMsgIndex],\n            content: result.result,\n            isLoading: false,\n            isStreaming: false,\n            performance_metrics: result.performance_metrics,\n            model_info: result.model_info,\n            timestamp: new Date().toISOString(),\n          };\n          console.log(\n            \"ìŠ¤íŠ¸ë¦¬ë° ì™„ë£Œ ì²˜ë¦¬ ì„±ê³µ:\",\n            updatedMessages[streamingMsgIndex].content\n          );\n        } else {\n          console.error(\n            \"ìŠ¤íŠ¸ë¦¬ë° ì™„ë£Œ ì²˜ë¦¬ ì¤‘ ë©”ì‹œì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ:\",\n            currentStreamingId\n          );\n        }\n\n        return updatedMessages;\n      });\n\n      // ìŠ¤íŠ¸ë¦¬ë° ID ì´ˆê¸°í™”\n      streamingMessageIdRef.current = null;\n\n      // ì…ë ¥ í™œì„±í™”\n      console.log(\"WebSocket ìŠ¤íŠ¸ë¦¬ë° ì™„ë£Œ - ì…ë ¥ í™œì„±í™”\");\n      setCanSendMessage(true);\n\n      // ìŠ¤í¬ë¡¤ ì¡°ì • (ìŠ¤íŠ¸ë¦¬ë° ì™„ë£Œ ì‹œì—ëŠ” í•­ìƒ í•˜ë‹¨ìœ¼ë¡œ)\n      scrollToBottom();\n    },\n    [scrollToBottom]\n  );\n\n  /**\n   * ìŠ¤íŠ¸ë¦¬ë° ì¤‘ë‹¨ í•¨ìˆ˜\n   */\n  const handleStopGeneration = useCallback(() => {\n    console.log(\"ìƒì„± ì¤‘ë‹¨ ìš”ì²­\");\n\n    // WebSocket ì—°ê²° ì¢…ë£Œ\n    if (currentWebSocketRef.current) {\n      currentWebSocketRef.current.close();\n      currentWebSocketRef.current = null;\n    }\n\n    // í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì‘ì—… ì¤‘ë‹¨\n    if (currentExecutionIdRef.current) {\n      // ì—¬ê¸°ì„œ ì‹¤ì œ API í˜¸ì¶œ ì¤‘ë‹¨ ë¡œì§ì„ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤\n      currentExecutionIdRef.current = null;\n    }\n\n    // ìŠ¤íŠ¸ë¦¬ë° ë©”ì‹œì§€ ìƒíƒœ ì—…ë°ì´íŠ¸\n    const currentStreamingId = streamingMessageIdRef.current;\n    if (currentStreamingId) {\n      setMessages((prev) => {\n        const updatedMessages = [...prev];\n        const streamingMsgIndex = updatedMessages.findIndex(\n          (msg) => msg.id === currentStreamingId\n        );\n\n        if (streamingMsgIndex !== -1) {\n          updatedMessages[streamingMsgIndex] = {\n            ...updatedMessages[streamingMsgIndex],\n            content:\n              updatedMessages[streamingMsgIndex].content +\n              \"\\n\\n[ìƒì„±ì´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤]\",\n            isLoading: false,\n            isStreaming: false,\n            timestamp: new Date().toISOString(),\n          };\n        }\n\n        return updatedMessages;\n      });\n\n      streamingMessageIdRef.current = null;\n    }\n\n    // ì…ë ¥ ê°€ëŠ¥ ìƒíƒœë¡œ ë³µì›\n    setCanSendMessage(true);\n\n    // orchestration ìƒíƒœ ë¦¬ì…‹\n    resetOrchestration();\n\n    toast.success(\"ìƒì„±ì´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤\");\n  }, [resetOrchestration]);\n\n  /**\n   * ì…ë ¥ì°½ ë†’ì´ ìë™ ì¡°ì ˆ\n   */\n  const adjustInputHeight = useCallback((value) => {\n    if (!value.trim()) {\n      setInputHeight(24); // ê¸°ë³¸ ë†’ì´\n      return;\n    }\n\n    // ì¤„ ìˆ˜ ê³„ì‚° (ëŒ€ëµì )\n    const lines = value.split(\"\\n\").length;\n    const charBasedLines = Math.ceil(value.length / 80); // 80ìë‹¹ 1ì¤„ë¡œ ì¶”ì •\n    const estimatedLines = Math.max(lines, charBasedLines);\n\n    // ë†’ì´ ê³„ì‚° (lineHeight: 1.4, fontSize: 16px)\n    let calculatedHeight;\n    if (estimatedLines <= 3) {\n      calculatedHeight = 24 + (estimatedLines - 1) * 22; // ê¸°ë³¸ + ì¶”ê°€ ì¤„\n    } else if (estimatedLines <= 10) {\n      calculatedHeight = 150 + (estimatedLines - 6) * 15; // ì¤‘ê°„ ë²”ìœ„\n    } else {\n      calculatedHeight = Math.min(400, 150 + (estimatedLines - 6) * 12); // ìµœëŒ€ 400px\n    }\n\n    setInputHeight(Math.max(24, calculatedHeight));\n  }, []);\n\n  /**\n   * ì…ë ¥ê°’ ë³€ê²½ ì²˜ë¦¬\n   */\n  const handleInputChange = useCallback(\n    (value) => {\n      setInputValue(value);\n      adjustInputHeight(value);\n    },\n    [adjustInputHeight]\n  );\n\n  /**\n   * ë©”ì‹œì§€ ì „ì†¡\n   */\n  const handleSendMessage = useCallback(async () => {\n    console.log(\"í•´ë“¤ ì „ì†¡ í˜¸ì¶œ:\", {\n      inputValue: inputValue.trim(),\n      isGenerating,\n      canSendMessage,\n    });\n\n    if (!inputValue.trim() || isGenerating) {\n      console.log(\"ì „ì†¡ ì¤‘ë‹¨: ì¡°ê±´ ë¶€ì¡±\");\n      return;\n    }\n\n    // ì…ë ¥ ë¹„í™œì„±í™”\n    console.log(\"ì…ë ¥ ë¹„í™œì„±í™”\");\n    setCanSendMessage(false);\n\n    const userMessage = {\n      id: \"user-\" + Date.now(),\n      type: \"user\",\n      content: inputValue.trim(),\n      timestamp: new Date().toISOString(),\n    };\n\n    // ìŠ¤íŠ¸ë¦¬ë° ë©”ì‹œì§€ ID ìƒì„±\n    const streamMsgId = \"streaming-\" + Date.now();\n    streamingMessageIdRef.current = streamMsgId;\n\n    console.log(\"ìƒˆ ìŠ¤íŠ¸ë¦¬ë° ë©”ì‹œì§€ ID ìƒì„±:\", streamMsgId);\n\n    // ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µì„ ìœ„í•œ ì´ˆê¸° ë©”ì‹œì§€\n    const streamingMessage = {\n      id: streamMsgId,\n      type: \"assistant\",\n      content: \"\",\n      timestamp: new Date().toISOString(),\n      isLoading: true,\n      isStreaming: true,\n    };\n\n    setMessages((prev) => [...prev, userMessage, streamingMessage]);\n    setInputValue(\"\");\n    setInputHeight(24); // ì…ë ¥ì°½ ë†’ì´ ì´ˆê¸°í™”\n\n    // ê¸°ì¡´ ë©”ì‹œì§€ + í˜„ì¬ ì‚¬ìš©ì ë©”ì‹œì§€ë¥¼ í¬í•¨í•œ ëŒ€í™” íˆìŠ¤í† ë¦¬ ìƒì„±\n    const allMessages = [...messages, userMessage];\n    const chatHistory = allMessages\n      .filter((msg) => !msg.isLoading && !msg.isError && !msg.isStreaming)\n      .map((msg) => ({\n        role: msg.type === \"user\" ? \"user\" : \"assistant\",\n        content: msg.content,\n      }));\n\n    // ìµœëŒ€ ëŒ€í™” ê¸°ì–µ ì„¤ì • (ìµœê·¼ 50ê°œ ë©”ì‹œì§€ë¡œ ìµœëŒ€ ë©”ëª¨ë¦¬ ìœ ì§€)\n    const maxHistoryLength = 50;\n    const trimmedChatHistory = chatHistory.slice(-maxHistoryLength);\n\n    console.log(\"ëŒ€í™” íˆìŠ¤í† ë¦¬ ìƒì„±:\", {\n      totalMessages: allMessages.length,\n      fullHistoryLength: chatHistory.length,\n      trimmedHistoryLength: trimmedChatHistory.length,\n      maxHistoryLength: maxHistoryLength,\n      recentHistory: trimmedChatHistory.slice(-6), // ìµœê·¼ 6ê°œë§Œ ë¡œê·¸ì— í‘œì‹œ\n    });\n\n    try {\n      // í”„ë¡¬í”„íŠ¸ ì¹´ë“œ ì •ë³´ ì¶”ê°€ - í™œì„±í™”ëœ ì¹´ë“œë§Œ í•„í„°ë§í•˜ê³  ë°±ì—”ë“œ í˜•ì‹ì— ë§ê²Œ ë³€í™˜\n      const safePromptCards = Array.isArray(promptCards) ? promptCards : [];\n      const activePromptCards = safePromptCards\n        .filter((card) => card.isActive !== false && card.enabled !== false)\n        .map((card) => ({\n          promptId: card.promptId || card.prompt_id,\n          title: card.title || \"Untitled\",\n          prompt_text: card.prompt_text || card.content || \"\",\n          tags: card.tags || [],\n          isActive: card.isActive !== false,\n          stepOrder: card.stepOrder || 0,\n        }))\n        .filter((card) => card.prompt_text.trim()) // í”„ë¡¬í”„íŠ¸ ë‚´ìš©ì´ ìˆëŠ” ê²ƒë§Œ\n        .sort((a, b) => (a.stepOrder || 0) - (b.stepOrder || 0)); // stepOrderë¡œ ì •ë ¬\n\n      console.log(\"ëŒ€í™” ì „ì†¡ ë°ì´í„° í™•ì¸:\", {\n        messageContent: userMessage.content,\n        chatHistoryLength: trimmedChatHistory.length,\n        promptCardsCount: activePromptCards.length,\n        chatHistory: trimmedChatHistory,\n        promptCards: activePromptCards.map((card) => ({\n          id: card.promptId,\n          title: card.title,\n          contentLength: card.prompt_text.length,\n          stepOrder: card.stepOrder,\n          hasContent: !!card.prompt_text.trim(),\n        })),\n      });\n\n      // WebSocket ì—°ê²° í™•ì¸ ë° ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë° ì‹œë„\n      if (wsConnected) {\n        console.log(\"WebSocketì„ í†µí•œ ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë° ì‹œì‘\");\n        console.log(\"ğŸ” [DEBUG] ìŠ¤íŠ¸ë¦¬ë° ë§¤ê°œë³€ìˆ˜ ìƒì„¸ í™•ì¸:\", {\n          projectId,\n          userInput: userMessage.content,\n          conversationId: conversationId,\n          userSub: user?.id,\n          historyLength: trimmedChatHistory.length,\n          promptCardsLength: activePromptCards.length,\n          conversationIdType: typeof conversationId,\n          conversationIdValue: conversationId,\n          isConversationIdNull: conversationId === null,\n          isConversationIdUndefined: conversationId === undefined,\n        });\n\n        const success = wsStartStreaming(\n          userMessage.content,\n          trimmedChatHistory,\n          activePromptCards,\n          selectedModel,\n          conversationId, // Add conversationId\n          user?.id // Add userSub from AuthContext\n        );\n\n        if (success) {\n          // WebSocket ìŠ¤íŠ¸ë¦¬ë° ì„±ê³µ, ë‚˜ë¨¸ì§€ëŠ” ë¦¬ìŠ¤ë„ˆì—ì„œ ì²˜ë¦¬\n          return;\n        } else {\n          console.log(\"WebSocket ì „ì†¡ ì‹¤íŒ¨, SSE í´ë°± ëª¨ë“œë¡œ ì „í™˜\");\n        }\n      } else {\n        console.log(\"WebSocket ë¯¸ì—°ê²°, SSE ëª¨ë“œ ì‚¬ìš©\");\n      }\n\n      // ğŸŒŸ ë©€í‹°-ì—ì´ì „íŠ¸ ì‹œìŠ¤í…œ ì‹¤í–‰\n      console.log(\"ë©€í‹°-ì—ì´ì „íŠ¸ ì‹œìŠ¤í…œ ì‹¤í–‰ ì‹œì‘\");\n\n      // 1. ë¨¼ì € í”„ë¡¬í”„íŠ¸ ì¹´ë“œë“¤ì„ crew ì¸ìŠ¤í„´ìŠ¤ë¡œ ìƒì„±\n      if (activePromptCards.length > 0) {\n        try {\n          console.log(\"í”„ë¡¬í”„íŠ¸ ì¹´ë“œ â†’ í¬ë£¨ ì¸ìŠ¤í„´ìŠ¤ ë³€í™˜ ì‹œë„\");\n          await crewAPI.createCrewInstance(projectId, activePromptCards);\n          console.log(\"í¬ë£¨ ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ì™„ë£Œ\");\n        } catch (instanceError) {\n          console.log(\"í¬ë£¨ ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ì‹¤íŒ¨:\", instanceError.message);\n\n          // 401 ì¸ì¦ ì˜¤ë¥˜ì¸ ê²½ìš° ì²˜ë¦¬ ì¤‘ë‹¨\n          if (instanceError.response?.status === 401) {\n            const { shouldRedirect } = await handleAPIError(instanceError);\n            if (shouldRedirect) {\n              return;\n            }\n          }\n\n          // ë‹¤ë¥¸ ì˜¤ë¥˜ëŠ” ë¡œê·¸ë§Œ ë‚¨ê¸°ê³  ê³„ì† ì§„í–‰ (ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ê²½ìš° ë“±)\n          console.log(\"í¬ë£¨ ì¸ìŠ¤í„´ìŠ¤ ê´€ë ¨ ì˜¤ë¥˜ì´ì§€ë§Œ ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤\");\n        }\n      }\n\n      // 2. ë©€í‹°-ì—ì´ì „íŠ¸ ë³‘ë ¬ ì‹¤í–‰\n      const multiAgentResult = await crewAPI.executeMultiAgent(\n        projectId,\n        userMessage.content,\n        (progress) => {\n          // ì§„í–‰ìƒí™© ì—…ë°ì´íŠ¸ (ì˜µì…˜)\n          console.log(\"ë©€í‹°-ì—ì´ì „íŠ¸ ì§„í–‰ìƒí™©:\", progress);\n        }\n      );\n\n      console.log(\"ë©€í‹°-ì—ì´ì „íŠ¸ ì‹¤í–‰ ì™„ë£Œ:\", multiAgentResult);\n\n      // 3. ê²°ê³¼ë¥¼ UI ë©”ì‹œì§€ë¡œ ë³€í™˜\n      const assistantMessage = processMultiAgentResponse(multiAgentResult);\n\n      // 4. ìŠ¤íŠ¸ë¦¬ë° ë©”ì‹œì§€ë¥¼ ìµœì¢… ê²°ê³¼ë¡œ êµì²´\n      setMessages((prev) => {\n        const updatedMessages = [...prev];\n        const streamingMsgIndex = updatedMessages.findIndex(\n          (msg) => msg.id === streamingMessageIdRef.current\n        );\n\n        if (streamingMsgIndex !== -1) {\n          updatedMessages[streamingMsgIndex] = assistantMessage;\n        } else {\n          updatedMessages.push(assistantMessage);\n        }\n\n        return updatedMessages;\n      });\n\n      streamingMessageIdRef.current = null;\n      setCanSendMessage(true);\n\n      // ì„±ê³µ í† ìŠ¤íŠ¸\n      toast.success(\n        `${\n          Object.keys(multiAgentResult.agentResults || {}).length\n        }ê°œ ì—ì´ì „íŠ¸ ë¶„ì„ ì™„ë£Œ!`\n      );\n    } catch (error) {\n      console.error(\"ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨:\", error);\n\n      // API ì˜¤ë¥˜ ì²˜ë¦¬ ìœ„ì„\n      const { userMessage: errorUserMessage, shouldRedirect } =\n        await handleAPIError(error);\n\n      // ì¸ì¦ ì˜¤ë¥˜ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ê°€ í•„ìš”í•œ ê²½ìš°\n      if (shouldRedirect) {\n        return;\n      }\n\n      const errorMessage = {\n        id: \"error-\" + Date.now(),\n        type: \"assistant\",\n        content: errorUserMessage,\n        timestamp: new Date().toISOString(),\n        isError: true,\n        errorDetails: {\n          message: error.message,\n          status: error.response?.status,\n          code: error.code,\n        },\n      };\n\n      setMessages((prev) => {\n        // ìŠ¤íŠ¸ë¦¬ë° ë©”ì‹œì§€ë¥¼ ì°¾ì•„ ì œê±°\n        const currentStreamingId = streamingMessageIdRef.current;\n        const filteredMessages = prev.filter(\n          (msg) => msg.id !== currentStreamingId\n        );\n        return [...filteredMessages, errorMessage];\n      });\n\n      streamingMessageIdRef.current = null;\n\n      // ì˜¤ë¥˜ ë°œìƒ ì‹œë„ ì…ë ¥ í™œì„±í™”\n      setCanSendMessage(true);\n    }\n\n    // ì „ì²´ ì „ì†¡ ê³¼ì • ì™„ë£Œ í›„ ì…ë ¥ í™œì„±í™” (ë³´í—˜ìš©)\n    setCanSendMessage(true);\n  }, [\n    inputValue,\n    isGenerating,\n    executeOrchestration,\n    handleStreamingResponse,\n    handleStreamingComplete,\n    messages,\n  ]);\n\n  /**\n   * Enter í‚¤ë¡œ ì „ì†¡\n   */\n  const handleKeyPress = useCallback(\n    (e) => {\n      if (e.key === \"Enter\" && !e.shiftKey) {\n        e.preventDefault();\n        handleSendMessage();\n      }\n    },\n    [handleSendMessage]\n  );\n\n  /**\n   * ë©”ì‹œì§€ ë³µì‚¬\n   */\n  const handleCopyMessage = useCallback(async (content, messageId) => {\n    const success = await copyToClipboard(content);\n    if (success) {\n      setCopiedMessage(messageId);\n      setTimeout(() => setCopiedMessage(null), 2000);\n    }\n  }, []);\n\n  /**\n   * ê°œë³„ ì œëª© ë³µì‚¬\n   */\n  const handleCopyTitle = useCallback(async (title, messageId, index) => {\n    const success = await copyToClipboard(title, \"ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\");\n    if (success) {\n      setCopiedMessage(`${messageId}_title_${index}`);\n      setTimeout(() => setCopiedMessage(null), 2000);\n    }\n  }, []);\n\n  /**\n   * ì±„íŒ… ì´ˆê¸°í™”\n   */\n  const resetChat = useCallback(() => {\n    setMessages([]);\n    setInputValue(\"\");\n    setCopiedMessage(null);\n    setCanSendMessage(true);\n    streamingMessageIdRef.current = null;\n    currentWebSocketRef.current = null;\n    currentExecutionIdRef.current = null;\n    resetOrchestration();\n  }, [resetOrchestration]);\n\n  return {\n    messages,\n    inputValue,\n    setInputValue,\n    handleInputChange, // ìƒˆë¡œìš´ ì…ë ¥ í•¸ë“¤ëŸ¬\n    copiedMessage,\n    isGenerating,\n    isStreaming,\n    canSendMessage,\n    streamingMessageId: streamingMessageIdRef.current,\n    messagesEndRef,\n    inputRef,\n    inputHeight, // ë™ì  ë†’ì´\n    handleSendMessage,\n    handleStopGeneration,\n    handleKeyPress,\n    handleCopyMessage,\n    handleCopyTitle,\n    resetChat,\n    scrollToBottom,\n    // WebSocket ìƒíƒœ ì¶”ê°€\n    wsConnected,\n    wsConnecting,\n    wsError,\n    // ìŠ¤í¬ë¡¤ ê´€ë ¨ ì¶”ê°€\n    scrollContainerRef,\n    handleScroll,\n    isUserScrolling,\n    // ëª¨ë¸ ì„ íƒ ê´€ë ¨ ì¶”ê°€\n    selectedModel,\n    setSelectedModel,\n  };\n};\n"],"mappings":"AAAA,OAASA,QAAQ,CAAEC,SAAS,CAAEC,MAAM,CAAEC,WAAW,KAAQ,OAAO,CAChE,OAASC,KAAK,KAAQ,iBAAiB,CACvC,OAASC,eAAe,KAAQ,oBAAoB,CACpD,OAASC,gBAAgB,KAAQ,oBAAoB,CACrD,OAASC,YAAY,KAAQ,gBAAgB,CAC7C,OAASC,OAAO,CAAEC,cAAc,KAAQ,iBAAiB,CACzD,OAASC,OAAO,KAAQ,yBAAyB,CAEjD;AACA;AACA,GACA,KAAM,CAAAC,yBAAyB,CAAIC,MAAM,EAAK,CAC5C,GAAI,CAACA,MAAM,CAAE,CACXC,OAAO,CAACC,KAAK,CAAC,yBAAyB,CAAEF,MAAM,CAAC,CAChD,MAAO,CACLG,EAAE,CAAE,QAAQ,CAAGC,IAAI,CAACC,GAAG,CAAC,CAAC,CACzBC,IAAI,CAAE,WAAW,CACjBC,OAAO,CAAE,6BAA6B,CACtCC,SAAS,CAAE,GAAI,CAAAJ,IAAI,CAAC,CAAC,CAACK,WAAW,CAAC,CAAC,CACnCC,OAAO,CAAE,IACX,CAAC,CACH,CAEA;AACA,KAAM,CAAAC,YAAY,CAAGX,MAAM,CAACW,YAAY,EAAI,CAAC,CAAC,CAC9C,KAAM,CAAAC,WAAW,CAAGZ,MAAM,CAACY,WAAW,EAAI,CAAC,CAAC,CAC5C,KAAM,CAAAC,UAAU,CAAGb,MAAM,CAACa,UAAU,EAAI,CAAC,CAEzC;AACA,KAAM,CAAAC,YAAY,CAAGC,MAAM,CAACC,IAAI,CAACL,YAAY,CAAC,CAACM,GAAG,CAAEC,SAAS,EAAK,CAChE,KAAM,CAAAC,WAAW,CAAGR,YAAY,CAACO,SAAS,CAAC,CAC3C,KAAM,CAAAE,MAAM,CAAGR,WAAW,CAACM,SAAS,CAAC,EAAI,EAAE,CAE3C,MAAO,CACLA,SAAS,CACTG,SAAS,CAAEC,YAAY,CAACJ,SAAS,CAAC,CAClClB,MAAM,CAAE,CAAAmB,WAAW,SAAXA,WAAW,iBAAXA,WAAW,CAAEZ,OAAO,GAAI,OAAO,CACvCa,MAAM,CAAEA,MAAM,CACdG,UAAU,CAAE,CAAAJ,WAAW,SAAXA,WAAW,iBAAXA,WAAW,CAAEI,UAAU,GAAI,CACzC,CAAC,CACH,CAAC,CAAC,CAEF;AACA,KAAM,CAAAC,SAAS,CAAGT,MAAM,CAACU,MAAM,CAACb,WAAW,CAAC,CAACc,IAAI,CAAC,CAAC,CAEnD,MAAO,CACLvB,EAAE,CAAE,cAAc,CAAGC,IAAI,CAACC,GAAG,CAAC,CAAC,CAC/BC,IAAI,CAAE,WAAW,CACjBC,OAAO,CAAEoB,uBAAuB,CAACb,YAAY,CAAEU,SAAS,CAAC,CACzDhB,SAAS,CAAE,GAAI,CAAAJ,IAAI,CAAC,CAAC,CACrB;AACAwB,YAAY,CAAE,IAAI,CAClBjB,YAAY,CAAEG,YAAY,CAC1BU,SAAS,CAAEA,SAAS,CACpBX,UAAU,CAAEA,UACd,CAAC,CACH,CAAC,CAED;AACA;AACA,GACA,KAAM,CAAAS,YAAY,CAAIJ,SAAS,EAAK,CAClC,KAAM,CAAAW,UAAU,CAAG,CACjBC,UAAU,CAAE,aAAa,CACzBC,QAAQ,CAAE,aAAa,CACvBC,KAAK,CAAE,UAAU,CACjBC,GAAG,CAAE,iBAAiB,CACtBC,MAAM,CAAE,cACV,CAAC,CACD,MAAO,CAAAL,UAAU,CAACX,SAAS,CAAC,EAAI,MAAMA,SAAS,EAAE,CACnD,CAAC,CAED;AACA;AACA,GACA,KAAM,CAAAS,uBAAuB,CAAGA,CAACb,YAAY,CAAEU,SAAS,GAAK,CAC3D,GAAI,CAAAjB,OAAO,CAAG,0BAA0B,CAExC;AACA,GAAIiB,SAAS,CAACW,MAAM,CAAG,CAAC,CAAE,CACxB5B,OAAO,EAAI,qBAAqB,CAChCiB,SAAS,CAACY,OAAO,CAAC,CAACC,KAAK,CAAEC,KAAK,GAAK,CAClC/B,OAAO,EAAI,GAAG+B,KAAK,CAAG,CAAC,KAAKD,KAAK,IAAI,CACvC,CAAC,CAAC,CACF9B,OAAO,EAAI,IAAI,CACjB,CAEA;AACAA,OAAO,EAAI,yBAAyB,CACpCO,YAAY,CAACsB,OAAO,CAAEG,KAAK,EAAK,CAC9BhC,OAAO,EAAI,OAAOgC,KAAK,CAAClB,SAAS,IAAI,CACrC,GAAIkB,KAAK,CAACnB,MAAM,CAACe,MAAM,CAAG,CAAC,CAAE,CAC3B5B,OAAO,EAAI,cAAc,CACzBgC,KAAK,CAACnB,MAAM,CAACgB,OAAO,CAAEC,KAAK,EAAK,CAC9B9B,OAAO,EAAI,KAAK8B,KAAK,IAAI,CAC3B,CAAC,CAAC,CACJ,CACA9B,OAAO,EAAI,eAAegC,KAAK,CAAChB,UAAU,OAAO,CACnD,CAAC,CAAC,CAEF,MAAO,CAAAhB,OAAO,CAChB,CAAC,CAED;AACA;AACA;AACA;AACA;AACA;AACA,GACA,MAAO,MAAM,CAAAiC,OAAO,CAAG,QAAAA,CACrBC,SAAS,CACTC,WAAW,CAGR,IAFH,CAAAC,WAAW,CAAAC,SAAA,CAAAT,MAAA,IAAAS,SAAA,MAAAC,SAAA,CAAAD,SAAA,IAAG,EAAE,IAChB,CAAAE,cAAc,CAAAF,SAAA,CAAAT,MAAA,IAAAS,SAAA,MAAAC,SAAA,CAAAD,SAAA,IAAG,IAAI,CAErB,KAAM,CAAEG,IAAK,CAAC,CAAGjD,OAAO,CAAC,CAAC,CAAE;AAE5B;AACA,KAAM,CAAAkD,aAAa,CAAG1D,MAAM,CAAC,IAAI,CAAC,CAClC,GAAI0D,aAAa,CAACC,OAAO,CAAE,CACzBhD,OAAO,CAACiD,GAAG,CAAC,yBAAyB,CAAE,CACrCT,SAAS,CACTC,WAAW,CACXS,iBAAiB,CAAER,WAAW,SAAXA,WAAW,iBAAXA,WAAW,CAAER,MAAM,CACtCW,cAAc,CACdM,kBAAkB,CAAE,MAAO,CAAAN,cAAc,CACzCO,oBAAoB,CAAEP,cAAc,GAAK,IAAI,CAC7CQ,yBAAyB,CAAER,cAAc,GAAKD,SAAS,CACvDU,MAAM,CAAER,IAAI,SAAJA,IAAI,iBAAJA,IAAI,CAAE5C,EAChB,CAAC,CAAC,CACF6C,aAAa,CAACC,OAAO,CAAG,KAAK,CAC/B,CAEA;AACA5D,SAAS,CAAC,IAAM,CACdY,OAAO,CAACiD,GAAG,CAAC,yCAAyC,CAAE,CACrDM,iBAAiB,CAAEV,cAAc,CACjCM,kBAAkB,CAAE,MAAO,CAAAN,cAAc,CACzCW,MAAM,CAAEX,cAAc,GAAK,IAAI,CAC/BY,WAAW,CAAEZ,cAAc,GAAKD,SAClC,CAAC,CAAC,CACJ,CAAC,CAAE,CAACC,cAAc,CAAC,CAAC,CACpB,KAAM,CAACa,QAAQ,CAAEC,WAAW,CAAC,CAAGxE,QAAQ,CAAC,EAAE,CAAC,CAC5C,KAAM,CAACyE,UAAU,CAAEC,aAAa,CAAC,CAAG1E,QAAQ,CAAC,EAAE,CAAC,CAChD,KAAM,CAAC2E,aAAa,CAAEC,gBAAgB,CAAC,CAAG5E,QAAQ,CAAC,IAAI,CAAC,CACxD,KAAM,CAAC6E,cAAc,CAAEC,iBAAiB,CAAC,CAAG9E,QAAQ,CAAC,IAAI,CAAC,CAC1D,KAAM,CAAC+E,WAAW,CAAEC,cAAc,CAAC,CAAGhF,QAAQ,CAAC,EAAE,CAAC,CAAE;AACpD,KAAM,CAACiF,aAAa,CAAEC,gBAAgB,CAAC,CAAGlF,QAAQ,CAChD,2CACF,CAAC,CACD,KAAM,CAAAmF,qBAAqB,CAAGjF,MAAM,CAAC,IAAI,CAAC,CAC1C,KAAM,CAAAkF,mBAAmB,CAAGlF,MAAM,CAAC,IAAI,CAAC,CACxC,KAAM,CAAAmF,qBAAqB,CAAGnF,MAAM,CAAC,IAAI,CAAC,CAE1C,KAAM,CAAAoF,cAAc,CAAGpF,MAAM,CAAC,IAAI,CAAC,CACnC,KAAM,CAAAqF,QAAQ,CAAGrF,MAAM,CAAC,IAAI,CAAC,CAE7B;AACA,KAAM,CAACsF,eAAe,CAAEC,kBAAkB,CAAC,CAAGzF,QAAQ,CAAC,KAAK,CAAC,CAC7D,KAAM,CAAA0F,kBAAkB,CAAGxF,MAAM,CAAC,IAAI,CAAC,CACvC,KAAM,CAAAyF,gBAAgB,CAAGzF,MAAM,CAAC,CAAC,CAAC,CAElC,KAAM,CACJ0F,WAAW,CAAEC,YAAY,CACzBC,WAAW,CACXC,oBAAoB,CACpBC,kBACF,CAAC,CAAG1F,gBAAgB,CAAC+C,SAAS,CAAC,CAE/B;AACA,KAAM,CACJ4C,WAAW,CAAEC,WAAW,CACxBC,YAAY,CAAEC,YAAY,CAC1BtF,KAAK,CAAEuF,OAAO,CACdC,cAAc,CAAEC,gBAAgB,CAChCC,kBAAkB,CAClBC,qBACF,CAAC,CAAGlG,YAAY,CAAC8C,SAAS,CAAC,CAE3B;AACApD,SAAS,CAAC,IAAM,CACduE,WAAW,CAAC,EAAE,CAAC,CAAE;AACnB,CAAC,CAAE,CAACnB,SAAS,CAAC,CAAC,CAAE;AAEjB;AACA,KAAM,CAAAqD,YAAY,CAAGvG,WAAW,CAAC,IAAM,CACrC,GAAI,CAACuF,kBAAkB,CAAC7B,OAAO,CAAE,OAEjC,KAAM,CAAA8C,SAAS,CAAGjB,kBAAkB,CAAC7B,OAAO,CAC5C,KAAM,CAAA+C,gBAAgB,CAAGD,SAAS,CAACE,SAAS,CAC5C,KAAM,CAAAC,YAAY,CAAGH,SAAS,CAACI,YAAY,CAAGJ,SAAS,CAACK,YAAY,CAEpE;AACA,GAAIC,IAAI,CAACC,GAAG,CAACN,gBAAgB,CAAGjB,gBAAgB,CAAC9B,OAAO,CAAC,CAAG,CAAC,CAAE,CAC7D,KAAM,CAAAsD,UAAU,CAAGP,gBAAgB,EAAIE,YAAY,CAAG,EAAE,CAExD;AACArB,kBAAkB,CAAC,CAAC0B,UAAU,CAAC,CACjC,CAEAxB,gBAAgB,CAAC9B,OAAO,CAAG+C,gBAAgB,CAC7C,CAAC,CAAE,EAAE,CAAC,CAEN,KAAM,CAAAQ,cAAc,CAAGjH,WAAW,CAAC,IAAM,CACvC;AACA,GAAI,CAACqF,eAAe,EAAIF,cAAc,CAACzB,OAAO,CAAE,CAC9CyB,cAAc,CAACzB,OAAO,CAACwD,cAAc,CAAC,CAAEC,QAAQ,CAAE,QAAS,CAAC,CAAC,CAC/D,CACF,CAAC,CAAE,CAAC9B,eAAe,CAAC,CAAC,CAErB;AACAvF,SAAS,CAAC,IAAM,CACdmH,cAAc,CAAC,CAAC,CAClB,CAAC,CAAE,CAAC7C,QAAQ,CAAE6C,cAAc,CAAC,CAAC,CAE9B;AACAnH,SAAS,CAAC,IAAM,CACd,KAAM,CAAAsH,sBAAsB,CAAIC,KAAK,EAAK,KAAAC,cAAA,CACxC,GAAI,CACF,KAAM,CAAAC,IAAI,CAAGC,IAAI,CAACC,KAAK,CAACJ,KAAK,CAACE,IAAI,CAAC,CACnC7G,OAAO,CAACiD,GAAG,CAAC,mBAAmB,CAAE4D,IAAI,CAAC,CAEtC,KAAM,CAAAG,kBAAkB,CAAG1C,qBAAqB,CAACtB,OAAO,CAExD,OAAQ6D,IAAI,CAACxG,IAAI,EACf,IAAK,cAAc,CACjBL,OAAO,CAACiD,GAAG,CAAC,mBAAmB,CAAC,CAChC,MAEF,IAAK,UAAU,CACb;AACAjD,OAAO,CAACiD,GAAG,CAAC,UAAU4D,IAAI,CAACI,IAAI,KAAKJ,IAAI,CAACK,QAAQ,IAAI,CAAC,CACtD,MAEF,IAAK,cAAc,CACjB,GAAIF,kBAAkB,CAAE,CACtBrD,WAAW,CAAEwD,IAAI,EAAK,CACpB,KAAM,CAAAC,eAAe,CAAG,CAAC,GAAGD,IAAI,CAAC,CACjC,KAAM,CAAAE,iBAAiB,CAAGD,eAAe,CAACE,SAAS,CAChDC,GAAG,EAAKA,GAAG,CAACrH,EAAE,GAAK8G,kBACtB,CAAC,CAEDhH,OAAO,CAACiD,GAAG,CAAC,YAAY,CAAE,CACxB+D,kBAAkB,CAClBK,iBAAiB,CACjBG,cAAc,CAAEL,IAAI,CAACjF,MAAM,CAC3B5B,OAAO,CAAEuG,IAAI,CAACvG,OAChB,CAAC,CAAC,CAEF,GAAI+G,iBAAiB,GAAK,CAAC,CAAC,CAAE,CAC5B;AACA,KAAM,CAAAI,cAAc,CAClBL,eAAe,CAACC,iBAAiB,CAAC,CAAC/G,OAAO,EAAI,EAAE,CAElD8G,eAAe,CAACC,iBAAiB,CAAC,CAAG,CACnC,GAAGD,eAAe,CAACC,iBAAiB,CAAC,CACrC/G,OAAO,CAAEmH,cAAc,CAAGZ,IAAI,CAACvG,OAAO,CACtCoH,SAAS,CAAE,IAAI,CACfzC,WAAW,CAAE,IACf,CAAC,CAEDjF,OAAO,CAACiD,GAAG,CACT,YAAY,CACZmE,eAAe,CAACC,iBAAiB,CACnC,CAAC,CACH,CAAC,IAAM,CACLrH,OAAO,CAACiD,GAAG,CACT,6BAA6B,CAC7BkE,IAAI,CAACnG,GAAG,CAAE2G,CAAC,EAAKA,CAAC,CAACzH,EAAE,CACtB,CAAC,CACH,CAEA,MAAO,CAAAkH,eAAe,CACxB,CAAC,CAAC,CACF;AACA,GAAI,CAACzC,eAAe,CAAE,CACpB4B,cAAc,CAAC,CAAC,CAClB,CACF,CAAC,IAAM,CACLvG,OAAO,CAACiD,GAAG,CAAC,2BAA2B,CAAC,CAC1C,CACA,MAEF,IAAK,iBAAiB,CACpB,GAAI+D,kBAAkB,CAAE,CACtBrD,WAAW,CAAEwD,IAAI,EAAK,CACpB,KAAM,CAAAC,eAAe,CAAG,CAAC,GAAGD,IAAI,CAAC,CACjC,KAAM,CAAAE,iBAAiB,CAAGD,eAAe,CAACE,SAAS,CAChDC,GAAG,EAAKA,GAAG,CAACrH,EAAE,GAAK8G,kBACtB,CAAC,CAED,GAAIK,iBAAiB,GAAK,CAAC,CAAC,CAAE,CAC5BD,eAAe,CAACC,iBAAiB,CAAC,CAAG,CACnC,GAAGD,eAAe,CAACC,iBAAiB,CAAC,CACrC/G,OAAO,CAAEuG,IAAI,CAACe,WAAW,CACzBF,SAAS,CAAE,KAAK,CAChBzC,WAAW,CAAE,KAAK,CAClB1E,SAAS,CAAE,GAAI,CAAAJ,IAAI,CAAC,CAAC,CAACK,WAAW,CAAC,CACpC,CAAC,CACH,CAEA,MAAO,CAAA4G,eAAe,CACxB,CAAC,CAAC,CACF9C,qBAAqB,CAACtB,OAAO,CAAG,IAAI,CACpCuD,cAAc,CAAC,CAAC,CAClB,CACA,MAEF,IAAK,OAAO,CACVvG,OAAO,CAACC,KAAK,CAAC,oBAAoB,CAAE4G,IAAI,CAACgB,OAAO,CAAC,CACjD,GAAIb,kBAAkB,CAAE,CACtBrD,WAAW,CAAEwD,IAAI,EAAK,CACpB,KAAM,CAAAC,eAAe,CAAG,CAAC,GAAGD,IAAI,CAAC,CACjC,KAAM,CAAAE,iBAAiB,CAAGD,eAAe,CAACE,SAAS,CAChDC,GAAG,EAAKA,GAAG,CAACrH,EAAE,GAAK8G,kBACtB,CAAC,CAED,GAAIK,iBAAiB,GAAK,CAAC,CAAC,CAAE,KAAAS,aAAA,CAAAC,cAAA,CAAAC,cAAA,CAAAC,cAAA,CAAAC,cAAA,CAAAC,cAAA,CAC5B;AACA,GAAI,CAAAC,YAAY,CACd,iCAAiC,CAEnC,GACE,CAAAN,aAAA,CAAAjB,IAAI,CAACgB,OAAO,UAAAC,aAAA,WAAZA,aAAA,CAAcO,QAAQ,CAAC,KAAK,CAAC,GAAAN,cAAA,CAC7BlB,IAAI,CAACgB,OAAO,UAAAE,cAAA,WAAZA,cAAA,CAAcM,QAAQ,CAAC,cAAc,CAAC,CACtC,CACAD,YAAY,CACV,0BAA0B,CAC9B,CAAC,IAAM,IACL,CAAAJ,cAAA,CAAAnB,IAAI,CAACgB,OAAO,UAAAG,cAAA,WAAZA,cAAA,CAAcK,QAAQ,CAAC,SAAS,CAAC,GAAAJ,cAAA,CACjCpB,IAAI,CAACgB,OAAO,UAAAI,cAAA,WAAZA,cAAA,CAAcI,QAAQ,CAAC,OAAO,CAAC,CAC/B,CACAD,YAAY,CACV,4CAA4C,CAChD,CAAC,IAAM,IACL,CAAAF,cAAA,CAAArB,IAAI,CAACgB,OAAO,UAAAK,cAAA,WAAZA,cAAA,CAAcG,QAAQ,CAAC,YAAY,CAAC,GAAAF,cAAA,CACpCtB,IAAI,CAACgB,OAAO,UAAAM,cAAA,WAAZA,cAAA,CAAcE,QAAQ,CAAC,IAAI,CAAC,CAC5B,CACAD,YAAY,CACV,gCAAgC,CACpC,CAEAhB,eAAe,CAACC,iBAAiB,CAAC,CAAG,CACnC,GAAGD,eAAe,CAACC,iBAAiB,CAAC,CACrC/G,OAAO,CAAE8H,YAAY,CACrBV,SAAS,CAAE,KAAK,CAChBzC,WAAW,CAAE,KAAK,CAClBxE,OAAO,CAAE,IAAI,CACbF,SAAS,CAAE,GAAI,CAAAJ,IAAI,CAAC,CAAC,CAACK,WAAW,CAAC,CACpC,CAAC,CACH,CAEA,MAAO,CAAA4G,eAAe,CACxB,CAAC,CAAC,CACF9C,qBAAqB,CAACtB,OAAO,CAAG,IAAI,CACtC,CAEA;AACA,KAAM,CAAAsF,YAAY,CAAG,CAAA1B,cAAA,CAAAC,IAAI,CAACgB,OAAO,UAAAjB,cAAA,WAAZA,cAAA,CAAcyB,QAAQ,CAAC,KAAK,CAAC,CAC9C,aAAa,CACb,iBAAiB,CACrB9I,KAAK,CAACU,KAAK,CAACqI,YAAY,CAAC,CACzB,MAEF,QACEtI,OAAO,CAACiD,GAAG,CAAC,0BAA0B,CAAE4D,IAAI,CAACxG,IAAI,CAAC,CACtD,CACF,CAAE,MAAOJ,KAAK,CAAE,CACdD,OAAO,CAACC,KAAK,CAAC,sBAAsB,CAAEA,KAAK,CAAC,CAC9C,CACF,CAAC,CAED,GAAIoF,WAAW,CAAE,CACfM,kBAAkB,CAACe,sBAAsB,CAAC,CAC5C,CAEA,MAAO,IAAM,CACX,GAAIrB,WAAW,CAAE,CACfO,qBAAqB,CAACc,sBAAsB,CAAC,CAC/C,CACF,CAAC,CACH,CAAC,CAAE,CAACrB,WAAW,CAAEM,kBAAkB,CAAEC,qBAAqB,CAAEW,cAAc,CAAC,CAAC,CAE5E;AACF;AACA,KACE,KAAM,CAAAgC,uBAAuB,CAAGjJ,WAAW,CACzC,CAACkJ,KAAK,CAAEC,QAAQ,GAAK,CACnB,KAAM,CAAAzB,kBAAkB,CAAG1C,qBAAqB,CAACtB,OAAO,CAExDhD,OAAO,CAACiD,GAAG,CAAC,QAAQ,CAAEuF,KAAK,CAAE,UAAU,CAAExB,kBAAkB,CAAC,CAE5D,GAAI,CAACA,kBAAkB,CAAE,CACvBhH,OAAO,CAACC,KAAK,CAAC,gBAAgB,CAAC,CAC/B,OACF,CAEA0D,WAAW,CAAEwD,IAAI,EAAK,CACpB,KAAM,CAAAC,eAAe,CAAG,CAAC,GAAGD,IAAI,CAAC,CACjC,KAAM,CAAAE,iBAAiB,CAAGD,eAAe,CAACE,SAAS,CAChDC,GAAG,EAAKA,GAAG,CAACrH,EAAE,GAAK8G,kBACtB,CAAC,CAED,GAAIK,iBAAiB,GAAK,CAAC,CAAC,CAAE,CAC5B;AACAD,eAAe,CAACC,iBAAiB,CAAC,CAAG,CACnC,GAAGD,eAAe,CAACC,iBAAiB,CAAC,CACrC/G,OAAO,CAAE8G,eAAe,CAACC,iBAAiB,CAAC,CAAC/G,OAAO,CAAGkI,KAAK,CAC3Dd,SAAS,CAAE,IAAI,CACfzC,WAAW,CAAE,IACf,CAAC,CACDjF,OAAO,CAACiD,GAAG,CACT,mBAAmB,CACnBmE,eAAe,CAACC,iBAAiB,CAAC,CAAC/G,OACrC,CAAC,CACH,CAAC,IAAM,CACLN,OAAO,CAACC,KAAK,CAAC,oBAAoB,CAAE+G,kBAAkB,CAAC,CACzD,CAEA,MAAO,CAAAI,eAAe,CACxB,CAAC,CAAC,CAEF;AACA,GAAI,CAACzC,eAAe,CAAE,CACpB4B,cAAc,CAAC,CAAC,CAClB,CACF,CAAC,CACD,CAACA,cAAc,CAAE5B,eAAe,CAClC,CAAC,CAED;AACF;AACA,KACE,KAAM,CAAA+D,uBAAuB,CAAGpJ,WAAW,CACxCS,MAAM,EAAK,CACV,KAAM,CAAAiH,kBAAkB,CAAG1C,qBAAqB,CAACtB,OAAO,CAExDhD,OAAO,CAACiD,GAAG,CAAC,UAAU,CAAElD,MAAM,CAAE,UAAU,CAAEiH,kBAAkB,CAAC,CAE/D,GAAI,CAACA,kBAAkB,CAAE,CACvBhH,OAAO,CAACC,KAAK,CAAC,wBAAwB,CAAC,CACvC,OACF,CAEA0D,WAAW,CAAEwD,IAAI,EAAK,CACpB,KAAM,CAAAC,eAAe,CAAG,CAAC,GAAGD,IAAI,CAAC,CACjC,KAAM,CAAAE,iBAAiB,CAAGD,eAAe,CAACE,SAAS,CAChDC,GAAG,EAAKA,GAAG,CAACrH,EAAE,GAAK8G,kBACtB,CAAC,CAED,GAAIK,iBAAiB,GAAK,CAAC,CAAC,CAAE,CAC5B;AACAD,eAAe,CAACC,iBAAiB,CAAC,CAAG,CACnC,GAAGD,eAAe,CAACC,iBAAiB,CAAC,CACrC/G,OAAO,CAAEP,MAAM,CAACA,MAAM,CACtB2H,SAAS,CAAE,KAAK,CAChBzC,WAAW,CAAE,KAAK,CAClB0D,mBAAmB,CAAE5I,MAAM,CAAC4I,mBAAmB,CAC/CC,UAAU,CAAE7I,MAAM,CAAC6I,UAAU,CAC7BrI,SAAS,CAAE,GAAI,CAAAJ,IAAI,CAAC,CAAC,CAACK,WAAW,CAAC,CACpC,CAAC,CACDR,OAAO,CAACiD,GAAG,CACT,gBAAgB,CAChBmE,eAAe,CAACC,iBAAiB,CAAC,CAAC/G,OACrC,CAAC,CACH,CAAC,IAAM,CACLN,OAAO,CAACC,KAAK,CACX,4BAA4B,CAC5B+G,kBACF,CAAC,CACH,CAEA,MAAO,CAAAI,eAAe,CACxB,CAAC,CAAC,CAEF;AACA9C,qBAAqB,CAACtB,OAAO,CAAG,IAAI,CAEpC;AACAhD,OAAO,CAACiD,GAAG,CAAC,4BAA4B,CAAC,CACzCgB,iBAAiB,CAAC,IAAI,CAAC,CAEvB;AACAsC,cAAc,CAAC,CAAC,CAClB,CAAC,CACD,CAACA,cAAc,CACjB,CAAC,CAED;AACF;AACA,KACE,KAAM,CAAAsC,oBAAoB,CAAGvJ,WAAW,CAAC,IAAM,CAC7CU,OAAO,CAACiD,GAAG,CAAC,UAAU,CAAC,CAEvB;AACA,GAAIsB,mBAAmB,CAACvB,OAAO,CAAE,CAC/BuB,mBAAmB,CAACvB,OAAO,CAAC8F,KAAK,CAAC,CAAC,CACnCvE,mBAAmB,CAACvB,OAAO,CAAG,IAAI,CACpC,CAEA;AACA,GAAIwB,qBAAqB,CAACxB,OAAO,CAAE,CACjC;AACAwB,qBAAqB,CAACxB,OAAO,CAAG,IAAI,CACtC,CAEA;AACA,KAAM,CAAAgE,kBAAkB,CAAG1C,qBAAqB,CAACtB,OAAO,CACxD,GAAIgE,kBAAkB,CAAE,CACtBrD,WAAW,CAAEwD,IAAI,EAAK,CACpB,KAAM,CAAAC,eAAe,CAAG,CAAC,GAAGD,IAAI,CAAC,CACjC,KAAM,CAAAE,iBAAiB,CAAGD,eAAe,CAACE,SAAS,CAChDC,GAAG,EAAKA,GAAG,CAACrH,EAAE,GAAK8G,kBACtB,CAAC,CAED,GAAIK,iBAAiB,GAAK,CAAC,CAAC,CAAE,CAC5BD,eAAe,CAACC,iBAAiB,CAAC,CAAG,CACnC,GAAGD,eAAe,CAACC,iBAAiB,CAAC,CACrC/G,OAAO,CACL8G,eAAe,CAACC,iBAAiB,CAAC,CAAC/G,OAAO,CAC1C,mBAAmB,CACrBoH,SAAS,CAAE,KAAK,CAChBzC,WAAW,CAAE,KAAK,CAClB1E,SAAS,CAAE,GAAI,CAAAJ,IAAI,CAAC,CAAC,CAACK,WAAW,CAAC,CACpC,CAAC,CACH,CAEA,MAAO,CAAA4G,eAAe,CACxB,CAAC,CAAC,CAEF9C,qBAAqB,CAACtB,OAAO,CAAG,IAAI,CACtC,CAEA;AACAiB,iBAAiB,CAAC,IAAI,CAAC,CAEvB;AACAkB,kBAAkB,CAAC,CAAC,CAEpB5F,KAAK,CAACwJ,OAAO,CAAC,aAAa,CAAC,CAC9B,CAAC,CAAE,CAAC5D,kBAAkB,CAAC,CAAC,CAExB;AACF;AACA,KACE,KAAM,CAAA6D,iBAAiB,CAAG1J,WAAW,CAAE2J,KAAK,EAAK,CAC/C,GAAI,CAACA,KAAK,CAACC,IAAI,CAAC,CAAC,CAAE,CACjB/E,cAAc,CAAC,EAAE,CAAC,CAAE;AACpB,OACF,CAEA;AACA,KAAM,CAAAgF,KAAK,CAAGF,KAAK,CAACG,KAAK,CAAC,IAAI,CAAC,CAAClH,MAAM,CACtC,KAAM,CAAAmH,cAAc,CAAGjD,IAAI,CAACkD,IAAI,CAACL,KAAK,CAAC/G,MAAM,CAAG,EAAE,CAAC,CAAE;AACrD,KAAM,CAAAqH,cAAc,CAAGnD,IAAI,CAACoD,GAAG,CAACL,KAAK,CAAEE,cAAc,CAAC,CAEtD;AACA,GAAI,CAAAI,gBAAgB,CACpB,GAAIF,cAAc,EAAI,CAAC,CAAE,CACvBE,gBAAgB,CAAG,EAAE,CAAG,CAACF,cAAc,CAAG,CAAC,EAAI,EAAE,CAAE;AACrD,CAAC,IAAM,IAAIA,cAAc,EAAI,EAAE,CAAE,CAC/BE,gBAAgB,CAAG,GAAG,CAAG,CAACF,cAAc,CAAG,CAAC,EAAI,EAAE,CAAE;AACtD,CAAC,IAAM,CACLE,gBAAgB,CAAGrD,IAAI,CAACsD,GAAG,CAAC,GAAG,CAAE,GAAG,CAAG,CAACH,cAAc,CAAG,CAAC,EAAI,EAAE,CAAC,CAAE;AACrE,CAEApF,cAAc,CAACiC,IAAI,CAACoD,GAAG,CAAC,EAAE,CAAEC,gBAAgB,CAAC,CAAC,CAChD,CAAC,CAAE,EAAE,CAAC,CAEN;AACF;AACA,KACE,KAAM,CAAAE,iBAAiB,CAAGrK,WAAW,CAClC2J,KAAK,EAAK,CACTpF,aAAa,CAACoF,KAAK,CAAC,CACpBD,iBAAiB,CAACC,KAAK,CAAC,CAC1B,CAAC,CACD,CAACD,iBAAiB,CACpB,CAAC,CAED;AACF;AACA,KACE,KAAM,CAAAY,iBAAiB,CAAGtK,WAAW,CAAC,SAAY,CAChDU,OAAO,CAACiD,GAAG,CAAC,WAAW,CAAE,CACvBW,UAAU,CAAEA,UAAU,CAACsF,IAAI,CAAC,CAAC,CAC7BlE,YAAY,CACZhB,cACF,CAAC,CAAC,CAEF,GAAI,CAACJ,UAAU,CAACsF,IAAI,CAAC,CAAC,EAAIlE,YAAY,CAAE,CACtChF,OAAO,CAACiD,GAAG,CAAC,cAAc,CAAC,CAC3B,OACF,CAEA;AACAjD,OAAO,CAACiD,GAAG,CAAC,SAAS,CAAC,CACtBgB,iBAAiB,CAAC,KAAK,CAAC,CAExB,KAAM,CAAA4F,WAAW,CAAG,CAClB3J,EAAE,CAAE,OAAO,CAAGC,IAAI,CAACC,GAAG,CAAC,CAAC,CACxBC,IAAI,CAAE,MAAM,CACZC,OAAO,CAAEsD,UAAU,CAACsF,IAAI,CAAC,CAAC,CAC1B3I,SAAS,CAAE,GAAI,CAAAJ,IAAI,CAAC,CAAC,CAACK,WAAW,CAAC,CACpC,CAAC,CAED;AACA,KAAM,CAAAsJ,WAAW,CAAG,YAAY,CAAG3J,IAAI,CAACC,GAAG,CAAC,CAAC,CAC7CkE,qBAAqB,CAACtB,OAAO,CAAG8G,WAAW,CAE3C9J,OAAO,CAACiD,GAAG,CAAC,mBAAmB,CAAE6G,WAAW,CAAC,CAE7C;AACA,KAAM,CAAAC,gBAAgB,CAAG,CACvB7J,EAAE,CAAE4J,WAAW,CACfzJ,IAAI,CAAE,WAAW,CACjBC,OAAO,CAAE,EAAE,CACXC,SAAS,CAAE,GAAI,CAAAJ,IAAI,CAAC,CAAC,CAACK,WAAW,CAAC,CAAC,CACnCkH,SAAS,CAAE,IAAI,CACfzC,WAAW,CAAE,IACf,CAAC,CAEDtB,WAAW,CAAEwD,IAAI,EAAK,CAAC,GAAGA,IAAI,CAAE0C,WAAW,CAAEE,gBAAgB,CAAC,CAAC,CAC/DlG,aAAa,CAAC,EAAE,CAAC,CACjBM,cAAc,CAAC,EAAE,CAAC,CAAE;AAEpB;AACA,KAAM,CAAA6F,WAAW,CAAG,CAAC,GAAGtG,QAAQ,CAAEmG,WAAW,CAAC,CAC9C,KAAM,CAAAI,WAAW,CAAGD,WAAW,CAC5BE,MAAM,CAAE3C,GAAG,EAAK,CAACA,GAAG,CAACG,SAAS,EAAI,CAACH,GAAG,CAAC9G,OAAO,EAAI,CAAC8G,GAAG,CAACtC,WAAW,CAAC,CACnEjE,GAAG,CAAEuG,GAAG,GAAM,CACb4C,IAAI,CAAE5C,GAAG,CAAClH,IAAI,GAAK,MAAM,CAAG,MAAM,CAAG,WAAW,CAChDC,OAAO,CAAEiH,GAAG,CAACjH,OACf,CAAC,CAAC,CAAC,CAEL;AACA,KAAM,CAAA8J,gBAAgB,CAAG,EAAE,CAC3B,KAAM,CAAAC,kBAAkB,CAAGJ,WAAW,CAACK,KAAK,CAAC,CAACF,gBAAgB,CAAC,CAE/DpK,OAAO,CAACiD,GAAG,CAAC,aAAa,CAAE,CACzBsH,aAAa,CAAEP,WAAW,CAAC9H,MAAM,CACjCsI,iBAAiB,CAAEP,WAAW,CAAC/H,MAAM,CACrCuI,oBAAoB,CAAEJ,kBAAkB,CAACnI,MAAM,CAC/CkI,gBAAgB,CAAEA,gBAAgB,CAClCM,aAAa,CAAEL,kBAAkB,CAACC,KAAK,CAAC,CAAC,CAAC,CAAG;AAC/C,CAAC,CAAC,CAEF,GAAI,CACF;AACA,KAAM,CAAAK,eAAe,CAAGC,KAAK,CAACC,OAAO,CAACnI,WAAW,CAAC,CAAGA,WAAW,CAAG,EAAE,CACrE,KAAM,CAAAoI,iBAAiB,CAAGH,eAAe,CACtCT,MAAM,CAAEa,IAAI,EAAKA,IAAI,CAACC,QAAQ,GAAK,KAAK,EAAID,IAAI,CAACE,OAAO,GAAK,KAAK,CAAC,CACnEjK,GAAG,CAAE+J,IAAI,GAAM,CACdG,QAAQ,CAAEH,IAAI,CAACG,QAAQ,EAAIH,IAAI,CAACI,SAAS,CACzC/I,KAAK,CAAE2I,IAAI,CAAC3I,KAAK,EAAI,UAAU,CAC/BgJ,WAAW,CAAEL,IAAI,CAACK,WAAW,EAAIL,IAAI,CAACzK,OAAO,EAAI,EAAE,CACnD+K,IAAI,CAAEN,IAAI,CAACM,IAAI,EAAI,EAAE,CACrBL,QAAQ,CAAED,IAAI,CAACC,QAAQ,GAAK,KAAK,CACjCM,SAAS,CAAEP,IAAI,CAACO,SAAS,EAAI,CAC/B,CAAC,CAAC,CAAC,CACFpB,MAAM,CAAEa,IAAI,EAAKA,IAAI,CAACK,WAAW,CAAClC,IAAI,CAAC,CAAC,CAAE;AAAA,CAC1CqC,IAAI,CAAC,CAACC,CAAC,CAAEC,CAAC,GAAK,CAACD,CAAC,CAACF,SAAS,EAAI,CAAC,GAAKG,CAAC,CAACH,SAAS,EAAI,CAAC,CAAC,CAAC,CAAE;AAE5DtL,OAAO,CAACiD,GAAG,CAAC,eAAe,CAAE,CAC3ByI,cAAc,CAAE7B,WAAW,CAACvJ,OAAO,CACnCqL,iBAAiB,CAAEtB,kBAAkB,CAACnI,MAAM,CAC5C0J,gBAAgB,CAAEd,iBAAiB,CAAC5I,MAAM,CAC1C+H,WAAW,CAAEI,kBAAkB,CAC/B3H,WAAW,CAAEoI,iBAAiB,CAAC9J,GAAG,CAAE+J,IAAI,GAAM,CAC5C7K,EAAE,CAAE6K,IAAI,CAACG,QAAQ,CACjB9I,KAAK,CAAE2I,IAAI,CAAC3I,KAAK,CACjByJ,aAAa,CAAEd,IAAI,CAACK,WAAW,CAAClJ,MAAM,CACtCoJ,SAAS,CAAEP,IAAI,CAACO,SAAS,CACzBQ,UAAU,CAAE,CAAC,CAACf,IAAI,CAACK,WAAW,CAAClC,IAAI,CAAC,CACtC,CAAC,CAAC,CACJ,CAAC,CAAC,CAEF;AACA,GAAI7D,WAAW,CAAE,CACfrF,OAAO,CAACiD,GAAG,CAAC,2BAA2B,CAAC,CACxCjD,OAAO,CAACiD,GAAG,CAAC,6BAA6B,CAAE,CACzCT,SAAS,CACTuJ,SAAS,CAAElC,WAAW,CAACvJ,OAAO,CAC9BuC,cAAc,CAAEA,cAAc,CAC9BmJ,OAAO,CAAElJ,IAAI,SAAJA,IAAI,iBAAJA,IAAI,CAAE5C,EAAE,CACjB+L,aAAa,CAAE5B,kBAAkB,CAACnI,MAAM,CACxCgB,iBAAiB,CAAE4H,iBAAiB,CAAC5I,MAAM,CAC3CiB,kBAAkB,CAAE,MAAO,CAAAN,cAAc,CACzCqJ,mBAAmB,CAAErJ,cAAc,CACnCO,oBAAoB,CAAEP,cAAc,GAAK,IAAI,CAC7CQ,yBAAyB,CAAER,cAAc,GAAKD,SAChD,CAAC,CAAC,CAEF,KAAM,CAAAmG,OAAO,CAAGrD,gBAAgB,CAC9BmE,WAAW,CAACvJ,OAAO,CACnB+J,kBAAkB,CAClBS,iBAAiB,CACjB1G,aAAa,CACbvB,cAAc,CAAE;AAChBC,IAAI,SAAJA,IAAI,iBAAJA,IAAI,CAAE5C,EAAG;AACX,CAAC,CAED,GAAI6I,OAAO,CAAE,CACX;AACA,OACF,CAAC,IAAM,CACL/I,OAAO,CAACiD,GAAG,CAAC,gCAAgC,CAAC,CAC/C,CACF,CAAC,IAAM,CACLjD,OAAO,CAACiD,GAAG,CAAC,0BAA0B,CAAC,CACzC,CAEA;AACAjD,OAAO,CAACiD,GAAG,CAAC,mBAAmB,CAAC,CAEhC;AACA,GAAI6H,iBAAiB,CAAC5I,MAAM,CAAG,CAAC,CAAE,CAChC,GAAI,CACFlC,OAAO,CAACiD,GAAG,CAAC,yBAAyB,CAAC,CACtC,KAAM,CAAAtD,OAAO,CAACwM,kBAAkB,CAAC3J,SAAS,CAAEsI,iBAAiB,CAAC,CAC9D9K,OAAO,CAACiD,GAAG,CAAC,eAAe,CAAC,CAC9B,CAAE,MAAOmJ,aAAa,CAAE,KAAAC,qBAAA,CACtBrM,OAAO,CAACiD,GAAG,CAAC,gBAAgB,CAAEmJ,aAAa,CAACvE,OAAO,CAAC,CAEpD;AACA,GAAI,EAAAwE,qBAAA,CAAAD,aAAa,CAACE,QAAQ,UAAAD,qBAAA,iBAAtBA,qBAAA,CAAwBE,MAAM,IAAK,GAAG,CAAE,CAC1C,KAAM,CAAEC,cAAe,CAAC,CAAG,KAAM,CAAA5M,cAAc,CAACwM,aAAa,CAAC,CAC9D,GAAII,cAAc,CAAE,CAClB,OACF,CACF,CAEA;AACAxM,OAAO,CAACiD,GAAG,CAAC,2BAA2B,CAAC,CAC1C,CACF,CAEA;AACA,KAAM,CAAAwJ,gBAAgB,CAAG,KAAM,CAAA9M,OAAO,CAAC+M,iBAAiB,CACtDlK,SAAS,CACTqH,WAAW,CAACvJ,OAAO,CAClB4G,QAAQ,EAAK,CACZ;AACAlH,OAAO,CAACiD,GAAG,CAAC,eAAe,CAAEiE,QAAQ,CAAC,CACxC,CACF,CAAC,CAEDlH,OAAO,CAACiD,GAAG,CAAC,gBAAgB,CAAEwJ,gBAAgB,CAAC,CAE/C;AACA,KAAM,CAAAE,gBAAgB,CAAG7M,yBAAyB,CAAC2M,gBAAgB,CAAC,CAEpE;AACA9I,WAAW,CAAEwD,IAAI,EAAK,CACpB,KAAM,CAAAC,eAAe,CAAG,CAAC,GAAGD,IAAI,CAAC,CACjC,KAAM,CAAAE,iBAAiB,CAAGD,eAAe,CAACE,SAAS,CAChDC,GAAG,EAAKA,GAAG,CAACrH,EAAE,GAAKoE,qBAAqB,CAACtB,OAC5C,CAAC,CAED,GAAIqE,iBAAiB,GAAK,CAAC,CAAC,CAAE,CAC5BD,eAAe,CAACC,iBAAiB,CAAC,CAAGsF,gBAAgB,CACvD,CAAC,IAAM,CACLvF,eAAe,CAACwF,IAAI,CAACD,gBAAgB,CAAC,CACxC,CAEA,MAAO,CAAAvF,eAAe,CACxB,CAAC,CAAC,CAEF9C,qBAAqB,CAACtB,OAAO,CAAG,IAAI,CACpCiB,iBAAiB,CAAC,IAAI,CAAC,CAEvB;AACA1E,KAAK,CAACwJ,OAAO,CACX,GACEjI,MAAM,CAACC,IAAI,CAAC0L,gBAAgB,CAAC/L,YAAY,EAAI,CAAC,CAAC,CAAC,CAACwB,MAAM,eAE3D,CAAC,CACH,CAAE,MAAOjC,KAAK,CAAE,KAAA4M,eAAA,CACd7M,OAAO,CAACC,KAAK,CAAC,YAAY,CAAEA,KAAK,CAAC,CAElC;AACA,KAAM,CAAE4J,WAAW,CAAEiD,gBAAgB,CAAEN,cAAe,CAAC,CACrD,KAAM,CAAA5M,cAAc,CAACK,KAAK,CAAC,CAE7B;AACA,GAAIuM,cAAc,CAAE,CAClB,OACF,CAEA,KAAM,CAAAO,YAAY,CAAG,CACnB7M,EAAE,CAAE,QAAQ,CAAGC,IAAI,CAACC,GAAG,CAAC,CAAC,CACzBC,IAAI,CAAE,WAAW,CACjBC,OAAO,CAAEwM,gBAAgB,CACzBvM,SAAS,CAAE,GAAI,CAAAJ,IAAI,CAAC,CAAC,CAACK,WAAW,CAAC,CAAC,CACnCC,OAAO,CAAE,IAAI,CACbuM,YAAY,CAAE,CACZnF,OAAO,CAAE5H,KAAK,CAAC4H,OAAO,CACtB0E,MAAM,EAAAM,eAAA,CAAE5M,KAAK,CAACqM,QAAQ,UAAAO,eAAA,iBAAdA,eAAA,CAAgBN,MAAM,CAC9BU,IAAI,CAAEhN,KAAK,CAACgN,IACd,CACF,CAAC,CAEDtJ,WAAW,CAAEwD,IAAI,EAAK,CACpB;AACA,KAAM,CAAAH,kBAAkB,CAAG1C,qBAAqB,CAACtB,OAAO,CACxD,KAAM,CAAAkK,gBAAgB,CAAG/F,IAAI,CAAC+C,MAAM,CACjC3C,GAAG,EAAKA,GAAG,CAACrH,EAAE,GAAK8G,kBACtB,CAAC,CACD,MAAO,CAAC,GAAGkG,gBAAgB,CAAEH,YAAY,CAAC,CAC5C,CAAC,CAAC,CAEFzI,qBAAqB,CAACtB,OAAO,CAAG,IAAI,CAEpC;AACAiB,iBAAiB,CAAC,IAAI,CAAC,CACzB,CAEA;AACAA,iBAAiB,CAAC,IAAI,CAAC,CACzB,CAAC,CAAE,CACDL,UAAU,CACVoB,YAAY,CACZE,oBAAoB,CACpBqD,uBAAuB,CACvBG,uBAAuB,CACvBhF,QAAQ,CACT,CAAC,CAEF;AACF;AACA,KACE,KAAM,CAAAyJ,cAAc,CAAG7N,WAAW,CAC/B8N,CAAC,EAAK,CACL,GAAIA,CAAC,CAACC,GAAG,GAAK,OAAO,EAAI,CAACD,CAAC,CAACE,QAAQ,CAAE,CACpCF,CAAC,CAACG,cAAc,CAAC,CAAC,CAClB3D,iBAAiB,CAAC,CAAC,CACrB,CACF,CAAC,CACD,CAACA,iBAAiB,CACpB,CAAC,CAED;AACF;AACA,KACE,KAAM,CAAA4D,iBAAiB,CAAGlO,WAAW,CAAC,MAAOgB,OAAO,CAAEmN,SAAS,GAAK,CAClE,KAAM,CAAA1E,OAAO,CAAG,KAAM,CAAAvJ,eAAe,CAACc,OAAO,CAAC,CAC9C,GAAIyI,OAAO,CAAE,CACXhF,gBAAgB,CAAC0J,SAAS,CAAC,CAC3BC,UAAU,CAAC,IAAM3J,gBAAgB,CAAC,IAAI,CAAC,CAAE,IAAI,CAAC,CAChD,CACF,CAAC,CAAE,EAAE,CAAC,CAEN;AACF;AACA,KACE,KAAM,CAAA4J,eAAe,CAAGrO,WAAW,CAAC,MAAO8C,KAAK,CAAEqL,SAAS,CAAEpL,KAAK,GAAK,CACrE,KAAM,CAAA0G,OAAO,CAAG,KAAM,CAAAvJ,eAAe,CAAC4C,KAAK,CAAE,UAAU,CAAC,CACxD,GAAI2G,OAAO,CAAE,CACXhF,gBAAgB,CAAC,GAAG0J,SAAS,UAAUpL,KAAK,EAAE,CAAC,CAC/CqL,UAAU,CAAC,IAAM3J,gBAAgB,CAAC,IAAI,CAAC,CAAE,IAAI,CAAC,CAChD,CACF,CAAC,CAAE,EAAE,CAAC,CAEN;AACF;AACA,KACE,KAAM,CAAA6J,SAAS,CAAGtO,WAAW,CAAC,IAAM,CAClCqE,WAAW,CAAC,EAAE,CAAC,CACfE,aAAa,CAAC,EAAE,CAAC,CACjBE,gBAAgB,CAAC,IAAI,CAAC,CACtBE,iBAAiB,CAAC,IAAI,CAAC,CACvBK,qBAAqB,CAACtB,OAAO,CAAG,IAAI,CACpCuB,mBAAmB,CAACvB,OAAO,CAAG,IAAI,CAClCwB,qBAAqB,CAACxB,OAAO,CAAG,IAAI,CACpCmC,kBAAkB,CAAC,CAAC,CACtB,CAAC,CAAE,CAACA,kBAAkB,CAAC,CAAC,CAExB,MAAO,CACLzB,QAAQ,CACRE,UAAU,CACVC,aAAa,CACb8F,iBAAiB,CAAE;AACnB7F,aAAa,CACbkB,YAAY,CACZC,WAAW,CACXjB,cAAc,CACd6J,kBAAkB,CAAEvJ,qBAAqB,CAACtB,OAAO,CACjDyB,cAAc,CACdC,QAAQ,CACRR,WAAW,CAAE;AACb0F,iBAAiB,CACjBf,oBAAoB,CACpBsE,cAAc,CACdK,iBAAiB,CACjBG,eAAe,CACfC,SAAS,CACTrH,cAAc,CACd;AACAlB,WAAW,CACXE,YAAY,CACZC,OAAO,CACP;AACAX,kBAAkB,CAClBgB,YAAY,CACZlB,eAAe,CACf;AACAP,aAAa,CACbC,gBACF,CAAC,CACH,CAAC","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}